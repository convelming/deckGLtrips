// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
import { CompositeLayer } from '@deck.gl/core';
import TextMultiIconLayer from './text-multi-icon-layer';
/* global fetch */

const DEFAULT_COLOR = [0, 0, 0, 255]; // TODO: support these options...
// const TEXT_ANCHOR = {
//   start: 1,
//   middle: 0,
//   end: -1
// };
// const ALIGNMENT_BASELINE = {
//   top: 1,
//   center: 0,
//   bottom: -1
// };

const defaultProps = {
  getText: x => x.text,
  getPosition: x => x.coordinates,
  getColor: x => x.color || DEFAULT_COLOR,
  getSize: x => x.size || 32,
  getAngle: x => x.angle || 0,
  getTextAnchor: x => x.textAnchor || 'middle',
  getAlignmentBaseline: x => x.alignmentBaseline || 'center',
  getPixelOffset: x => x.pixelOffset || [0, 0],
  fp64: false,
  fontTexture: null,
  fontInfo: null,
  fontSmoothing: 0.2
};
export default class AdvancedTextLayer extends CompositeLayer {
  initializeState() {
    this.state = {
      iconAtlas: this.props.fontTexture,
      iconMapping: null
    }; // TODO: fetch again if props change

    fetch(this.props.fontInfo).then(response => {
      response.json().then(json => this.parseFontInfo(json));
    });
  }

  parseFontInfo(json) {
    const iconMapping = {};
    json.forEach(fontChar => {
      const charid = fontChar.charid,
            x = fontChar.x,
            y = fontChar.y,
            width = fontChar.width,
            height = fontChar.height,
            xadvance = fontChar.xadvance,
            xoffset = fontChar.xoffset,
            yoffset = fontChar.yoffset;
      iconMapping[String.fromCharCode(charid)] = {
        x,
        y,
        width,
        height,
        mask: true,
        xadvance,
        xoffset,
        yoffset
      };
    });
    this.setState({
      iconMapping
    });
  }

  updateState({
    props,
    oldProps,
    changeFlags
  }) {
    if (changeFlags.dataChanged || changeFlags.updateTriggersChanged && (changeFlags.updateTriggersChanged.all || changeFlags.updateTriggersChanged.getText || changeFlags.updateTriggersChanged.getPosition)) {
      this.transformStringToLetters();
    }
  }

  transformStringToLetters() {
    const _this$props = this.props,
          data = _this$props.data,
          getText = _this$props.getText,
          getPosition = _this$props.getPosition;

    if (data.length === 0) {
      return;
    } // TODO: auto-refresh when iconMapping is available


    const iconMapping = this.state.iconMapping;

    if (!iconMapping) {
      return;
    }

    const transformedData = data.map(val => {
      const text = getText(val);

      if (!text) {
        return [];
      }

      const position = getPosition(val);
      let xpos = 0;
      return Array.from(text).map((letter, index) => {
        const _this$state$iconMappi = this.state.iconMapping[letter],
              xadvance = _this$state$iconMappi.xadvance,
              xoffset = _this$state$iconMappi.xoffset,
              yoffset = _this$state$iconMappi.yoffset,
              width = _this$state$iconMappi.width,
              height = _this$state$iconMappi.height;
        const x = xpos + (width / 2.0 - xoffset);
        const y = height / 2.0 + yoffset;
        xpos += xadvance;
        return {
          icon: letter,
          position,
          x,
          y
        };
      });
    }).reduce((prev, curr) => [...prev, ...curr]);
    this.setState({
      data: transformedData
    });
  }

  renderLayers() {
    const _this$state = this.state,
          data = _this$state.data,
          iconAtlas = _this$state.iconAtlas,
          iconMapping = _this$state.iconMapping;

    if (!iconMapping || !iconAtlas || !data) {
      return null;
    }

    const _this$props2 = this.props,
          getColor = _this$props2.getColor,
          getSize = _this$props2.getSize,
          getAngle = _this$props2.getAngle,
          getPixelOffset = _this$props2.getPixelOffset,
          fontSmoothing = _this$props2.fontSmoothing,
          fp64 = _this$props2.fp64,
          sizeScale = _this$props2.sizeScale;
    return [new TextMultiIconLayer(this.getSubLayerProps({
      id: 'adv-text-multi-icon-layer',
      data,
      iconAtlas,
      iconMapping,
      getColor,
      getSize,
      getAngle,
      getPixelOffset,
      fontSmoothing,
      fp64,
      sizeScale,
      updateTriggers: {
        getAngle,
        getColor,
        getSize
      }
    }))];
  }

}
AdvancedTextLayer.layerName = 'AdvancedTextLayer';
AdvancedTextLayer.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZHZhbmNlZC10ZXh0LWxheWVyL2FkdmFuY2VkLXRleHQtbGF5ZXIuanMiXSwibmFtZXMiOlsiQ29tcG9zaXRlTGF5ZXIiLCJUZXh0TXVsdGlJY29uTGF5ZXIiLCJERUZBVUxUX0NPTE9SIiwiZGVmYXVsdFByb3BzIiwiZ2V0VGV4dCIsIngiLCJ0ZXh0IiwiZ2V0UG9zaXRpb24iLCJjb29yZGluYXRlcyIsImdldENvbG9yIiwiY29sb3IiLCJnZXRTaXplIiwic2l6ZSIsImdldEFuZ2xlIiwiYW5nbGUiLCJnZXRUZXh0QW5jaG9yIiwidGV4dEFuY2hvciIsImdldEFsaWdubWVudEJhc2VsaW5lIiwiYWxpZ25tZW50QmFzZWxpbmUiLCJnZXRQaXhlbE9mZnNldCIsInBpeGVsT2Zmc2V0IiwiZnA2NCIsImZvbnRUZXh0dXJlIiwiZm9udEluZm8iLCJmb250U21vb3RoaW5nIiwiQWR2YW5jZWRUZXh0TGF5ZXIiLCJpbml0aWFsaXplU3RhdGUiLCJzdGF0ZSIsImljb25BdGxhcyIsInByb3BzIiwiaWNvbk1hcHBpbmciLCJmZXRjaCIsInRoZW4iLCJyZXNwb25zZSIsImpzb24iLCJwYXJzZUZvbnRJbmZvIiwiZm9yRWFjaCIsImZvbnRDaGFyIiwiY2hhcmlkIiwieSIsIndpZHRoIiwiaGVpZ2h0IiwieGFkdmFuY2UiLCJ4b2Zmc2V0IiwieW9mZnNldCIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsIm1hc2siLCJzZXRTdGF0ZSIsInVwZGF0ZVN0YXRlIiwib2xkUHJvcHMiLCJjaGFuZ2VGbGFncyIsImRhdGFDaGFuZ2VkIiwidXBkYXRlVHJpZ2dlcnNDaGFuZ2VkIiwiYWxsIiwidHJhbnNmb3JtU3RyaW5nVG9MZXR0ZXJzIiwiZGF0YSIsImxlbmd0aCIsInRyYW5zZm9ybWVkRGF0YSIsIm1hcCIsInZhbCIsInBvc2l0aW9uIiwieHBvcyIsIkFycmF5IiwiZnJvbSIsImxldHRlciIsImluZGV4IiwiaWNvbiIsInJlZHVjZSIsInByZXYiLCJjdXJyIiwicmVuZGVyTGF5ZXJzIiwic2l6ZVNjYWxlIiwiZ2V0U3ViTGF5ZXJQcm9wcyIsImlkIiwidXBkYXRlVHJpZ2dlcnMiLCJsYXllck5hbWUiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBRUEsU0FBUUEsY0FBUixRQUE2QixlQUE3QjtBQUNBLE9BQU9DLGtCQUFQLE1BQStCLHlCQUEvQjtBQUVBOztBQUVBLE1BQU1DLGFBQWEsR0FBRyxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sQ0FBUCxFQUFVLEdBQVYsQ0FBdEIsQyxDQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUEsTUFBTUMsWUFBWSxHQUFHO0FBQ25CQyxFQUFBQSxPQUFPLEVBQUVDLENBQUMsSUFBSUEsQ0FBQyxDQUFDQyxJQURHO0FBRW5CQyxFQUFBQSxXQUFXLEVBQUVGLENBQUMsSUFBSUEsQ0FBQyxDQUFDRyxXQUZEO0FBR25CQyxFQUFBQSxRQUFRLEVBQUVKLENBQUMsSUFBSUEsQ0FBQyxDQUFDSyxLQUFGLElBQVdSLGFBSFA7QUFJbkJTLEVBQUFBLE9BQU8sRUFBRU4sQ0FBQyxJQUFJQSxDQUFDLENBQUNPLElBQUYsSUFBVSxFQUpMO0FBS25CQyxFQUFBQSxRQUFRLEVBQUVSLENBQUMsSUFBSUEsQ0FBQyxDQUFDUyxLQUFGLElBQVcsQ0FMUDtBQU1uQkMsRUFBQUEsYUFBYSxFQUFFVixDQUFDLElBQUlBLENBQUMsQ0FBQ1csVUFBRixJQUFnQixRQU5qQjtBQU9uQkMsRUFBQUEsb0JBQW9CLEVBQUVaLENBQUMsSUFBSUEsQ0FBQyxDQUFDYSxpQkFBRixJQUF1QixRQVAvQjtBQVFuQkMsRUFBQUEsY0FBYyxFQUFFZCxDQUFDLElBQUlBLENBQUMsQ0FBQ2UsV0FBRixJQUFpQixDQUFDLENBQUQsRUFBSSxDQUFKLENBUm5CO0FB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LENBQUNtRCxTQUFsQixHQUE4QixtQkFBOUI7QUFDQW5ELGlCQUFpQixDQUFDdEIsWUFBbEIsR0FBaUNBLFlBQWpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDE1IC0gMjAxNyBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7Q29tcG9zaXRlTGF5ZXJ9IGZyb20gJ0BkZWNrLmdsL2NvcmUnO1xuaW1wb3J0IFRleHRNdWx0aUljb25MYXllciBmcm9tICcuL3RleHQtbXVsdGktaWNvbi1sYXllcic7XG5cbi8qIGdsb2JhbCBmZXRjaCAqL1xuXG5jb25zdCBERUZBVUxUX0NPTE9SID0gWzAsIDAsIDAsIDI1NV07XG4vLyBUT0RPOiBzdXBwb3J0IHRoZXNlIG9wdGlvbnMuLi5cbi8vIGNvbnN0IFRFWFRfQU5DSE9SID0ge1xuLy8gICBzdGFydDogMSxcbi8vICAgbWlkZGxlOiAwLFxuLy8gICBlbmQ6IC0xXG4vLyB9O1xuLy8gY29uc3QgQUxJR05NRU5UX0JBU0VMSU5FID0ge1xuLy8gICB0b3A6IDEsXG4vLyAgIGNlbnRlcjogMCxcbi8vICAgYm90dG9tOiAtMVxuLy8gfTtcblxuY29uc3QgZGVmYXVsdFByb3BzID0ge1xuICBnZXRUZXh0OiB4ID0+IHgudGV4dCxcbiAgZ2V0UG9zaXRpb246IHggPT4geC5jb29yZGluYXRlcyxcbiAgZ2V0Q29sb3I6IHggPT4geC5jb2xvciB8fCBERUZBVUxUX0NPTE9SLFxuICBnZXRTaXplOiB4ID0+IHguc2l6ZSB8fCAzMixcbiAgZ2V0QW5nbGU6IHggPT4geC5hbmdsZSB8fCAwLFxuICBnZXRUZXh0QW5jaG9yOiB4ID0+IHgudGV4dEFuY2hvciB8fCAnbWlkZGxlJyxcbiAgZ2V0QWxpZ25tZW50QmFzZWxpbmU6IHggPT4geC5hbGlnbm1lbnRCYXNlbGluZSB8fCAnY2VudGVyJyxcbiAgZ2V0UGl4ZWxPZmZzZXQ6IHggPT4geC5waXhlbE9mZnNldCB8fCBbMCwgMF0sXG4gIGZwNjQ6IGZhbHNlLFxuICBmb250VGV4dHVyZTogbnVsbCxcbiAgZm9udEluZm86IG51bGwsXG4gIGZvbnRTbW9vdGhpbmc6IDAuMlxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQWR2YW5jZWRUZXh0TGF5ZXIgZXh0ZW5kcyBDb21wb3NpdGVMYXllciB7XG4gIGluaXRpYWxpemVTdGF0ZSgpIHtcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgaWNvbkF0bGFzOiB0aGlzLnByb3BzLmZvbnRUZXh0dXJlLFxuICAgICAgaWNvbk1hcHBpbmc6IG51bGxcbiAgICB9O1xuXG4gICAgLy8gVE9ETzogZmV0Y2ggYWdhaW4gaWYgcHJvcHMgY2hhbmdlXG4gICAgZmV0Y2godGhpcy5wcm9wcy5mb250SW5mbykudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICByZXNwb25zZS5qc29uKCkudGhlbihqc29uID0+IHRoaXMucGFyc2VGb250SW5mbyhqc29uKSk7XG4gICAgfSk7XG4gIH1cblxuICBwYXJzZUZvbnRJbmZvKGpzb24pIHtcbiAgICBjb25zdCBpY29uTWFwcGluZyA9IHt9O1xuICAgIGpzb24uZm9yRWFjaChmb250Q2hhciA9PiB7XG4gICAgICBjb25zdCB7Y2hhcmlkLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCB4YWR2YW5jZSwgeG9mZnNldCwgeW9mZnNldH0gPSBmb250Q2hhcjtcbiAgICAgIGljb25NYXBwaW5nW1N0cmluZy5mcm9tQ2hhckNvZGUoY2hhcmlkKV0gPSB7XG4gICAgICAgIHgsXG4gICAgICAgIHksXG4gICAgICAgIHdpZHRoLFxuICAgICAgICBoZWlnaHQsXG4gICAgICAgIG1hc2s6IHRydWUsXG4gICAgICAgIHhhZHZhbmNlLFxuICAgICAgICB4b2Zmc2V0LFxuICAgICAgICB5b2Zmc2V0XG4gICAgICB9O1xuICAgIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoe2ljb25NYXBwaW5nfSk7XG4gIH1cblxuICB1cGRhdGVTdGF0ZSh7cHJvcHMsIG9sZFByb3BzLCBjaGFuZ2VGbGFnc30pIHtcbiAgICBpZiAoXG4gICAgICBjaGFuZ2VGbGFncy5kYXRhQ2hhbmdlZCB8fFxuICAgICAgKGNoYW5nZUZsYWdzLnVwZGF0ZVRyaWdnZXJzQ2hhbmdlZCAmJlxuICAgICAgICAoY2hhbmdlRmxhZ3MudXBkYXRlVHJpZ2dlcnNDaGFuZ2VkLmFsbCB8fFxuICAgICAgICAgIGNoYW5nZUZsYWdzLnVwZGF0ZVRyaWdnZXJzQ2hhbmdlZC5nZXRUZXh0IHx8XG4gICAgICAgICAgY2hhbmdlRmxhZ3MudXBkYXRlVHJpZ2dlcnNDaGFuZ2VkLmdldFBvc2l0aW9uKSlcbiAgICApIHtcbiAgICAgIHRoaXMudHJhbnNmb3JtU3RyaW5nVG9MZXR0ZXJzKCk7XG4gICAgfVxuICB9XG5cbiAgdHJhbnNmb3JtU3RyaW5nVG9MZXR0ZXJzKCkge1xuICAgIGNvbnN0IHtkYXRhLCBnZXRUZXh0LCBnZXRQb3NpdGlvbn0gPSB0aGlzLnByb3BzO1xuICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFRPRE86IGF1dG8tcmVmcmVzaCB3aGVuIGljb25NYXBwaW5nIGlzIGF2YWlsYWJsZVxuICAgIGNvbnN0IHtpY29uTWFwcGluZ30gPSB0aGlzLnN0YXRlO1xuICAgIGlmICghaWNvbk1hcHBpbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0cmFuc2Zvcm1lZERhdGEgPSBkYXRhXG4gICAgICAubWFwKHZhbCA9PiB7XG4gICAgICAgIGNvbnN0IHRleHQgPSBnZXRUZXh0KHZhbCk7XG4gICAgICAgIGlmICghdGV4dCkge1xuICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZ2V0UG9zaXRpb24odmFsKTtcbiAgICAgICAgbGV0IHhwb3MgPSAwO1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0ZXh0KS5tYXAoKGxldHRlciwgaW5kZXgpID0+IHtcbiAgICAgICAgICBjb25zdCB7eGFkdmFuY2UsIHhvZmZzZXQsIHlvZmZzZXQsIHdpZHRoLCBoZWlnaHR9ID0gdGhpcy5zdGF0ZS5pY29uTWFwcGluZ1tsZXR0ZXJdO1xuXG4gICAgICAgICAgY29uc3QgeCA9IHhwb3MgKyAod2lkdGggLyAyLjAgLSB4b2Zmc2V0KTtcbiAgICAgICAgICBjb25zdCB5ID0gaGVpZ2h0IC8gMi4wICsgeW9mZnNldDtcbiAgICAgICAgICB4cG9zICs9IHhhZHZhbmNlO1xuXG4gICAgICAgICAgcmV0dXJuIHtpY29uOiBsZXR0ZXIsIHBvc2l0aW9uLCB4LCB5fTtcbiAgICAgICAgfSk7XG4gICAgICB9KVxuICAgICAgLnJlZHVjZSgocHJldiwgY3VycikgPT4gWy4uLnByZXYsIC4uLmN1cnJdKTtcblxuICAgIHRoaXMuc2V0U3RhdGUoe2RhdGE6IHRyYW5zZm9ybWVkRGF0YX0pO1xuICB9XG5cbiAgcmVuZGVyTGF5ZXJzKCkge1xuICAgIGNvbnN0IHtkYXRhLCBpY29uQXRsYXMsIGljb25NYXBwaW5nfSA9IHRoaXMuc3RhdGU7XG5cbiAgICBpZiAoIWljb25NYXBwaW5nIHx8ICFpY29uQXRsYXMgfHwgIWRhdGEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIGdldENvbG9yLFxuICAgICAgZ2V0U2l6ZSxcbiAgICAgIGdldEFuZ2xlLFxuICAgICAgZ2V0UGl4ZWxPZmZzZXQsXG4gICAgICBmb250U21vb3RoaW5nLFxuICAgICAgZnA2NCxcbiAgICAgIHNpemVTY2FsZVxuICAgIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgcmV0dXJuIFtcbiAgICAgIG5ldyBUZXh0TXVsdGlJY29uTGF5ZXIoXG4gICAgICAgIHRoaXMuZ2V0U3ViTGF5ZXJQcm9wcyh7XG4gICAgICAgICAgaWQ6ICdhZHYtdGV4dC1tdWx0aS1pY29uLWxheWVyJyxcbiAgICAgICAgICBkYXRhLFxuICAgICAgICAgIGljb25BdGxhcyxcbiAgICAgICAgICBpY29uTWFwcGluZyxcbiAgICAgICAgICBnZXRDb2xvcixcbiAgICAgICAgICBnZXRTaXplLFxuICAgICAgICAgIGdldEFuZ2xlLFxuICAgICAgICAgIGdldFBpeGVsT2Zmc2V0LFxuICAgICAgICAgIGZvbnRTbW9vdGhpbmcsXG4gICAgICAgICAgZnA2NCxcbiAgICAgICAgICBzaXplU2NhbGUsXG4gICAgICAgICAgdXBkYXRlVHJpZ2dlcnM6IHtcbiAgICAgICAgICAgIGdldEFuZ2xlLFxuICAgICAgICAgICAgZ2V0Q29sb3IsXG4gICAgICAgICAgICBnZXRTaXplXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKVxuICAgIF07XG4gIH1cbn1cblxuQWR2YW5jZWRUZXh0TGF5ZXIubGF5ZXJOYW1lID0gJ0FkdmFuY2VkVGV4dExheWVyJztcbkFkdmFuY2VkVGV4dExheWVyLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcztcbiJdfQ==