// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
import { Layer } from '@deck.gl/core';
import GL from 'luma.gl/constants';
import { Model, Geometry, fp64 } from 'luma.gl';
const fp64LowPart = fp64.fp64LowPart;
import vs from './bezier-curve-layer-vertex.glsl';
import fs from './bezier-curve-layer-fragment.glsl';
const NUM_SEGMENTS = 40;
const DEFAULT_COLOR = [0, 0, 0, 255];
const defaultProps = {
  strokeWidth: 1,
  fp64: false,
  getSourcePosition: x => x.sourcePosition,
  getTargetPosition: x => x.targetPosition,
  getControlPoint: x => x.controlPoint,
  getColor: x => x.color || DEFAULT_COLOR
};
export default class BezierCurveLayer extends Layer {
  getShaders() {
    return {
      vs,
      fs,
      modules: ['picking']
    };
  }

  initializeState() {
    const attributeManager = this.state.attributeManager;
    /* eslint-disable max-len */

    attributeManager.addInstanced({
      instanceSourcePositions: {
        size: 3,
        transition: true,
        accessor: 'getSourcePosition',
        update: this.calculateInstanceSourcePositions
      },
      instanceTargetPositions: {
        size: 3,
        transition: true,
        accessor: 'getTargetPosition',
        update: this.calculateInstanceTargetPositions
      },
      instanceControlPoints: {
        size: 3,
        transition: false,
        accessor: 'getControlPoint',
        update: this.calculateInstanceControlPoints
      },
      instanceColors: {
        size: 4,
        type: GL.UNSIGNED_BYTE,
        transition: true,
        accessor: 'getColor',
        update: this.calculateInstanceColors
      }
    });
    /* eslint-enable max-len */
  }

  updateAttribute({
    props,
    oldProps,
    changeFlags
  }) {
    if (props.fp64 !== oldProps.fp64) {
      const attributeManager = this.state.attributeManager;
      attributeManager.invalidateAll();
    }
  }

  updateState({
    props,
    oldProps,
    changeFlags
  }) {
    super.updateState({
      props,
      oldProps,
      changeFlags
    });

    if (props.fp64 !== oldProps.fp64) {
      const gl = this.context.gl;
      this.setState({
        model: this._getModel(gl)
      });
    }

    this.updateAttribute({
      props,
      oldProps,
      changeFlags
    });
  }

  draw({
    uniforms
  }) {
    const strokeWidth = this.props.strokeWidth;
    this.state.model.render(Object.assign({}, uniforms, {
      strokeWidth
    }));
  }

  _getModel(gl) {
    /*
     *  (0, -1)-------------_(1, -1)
     *       |          _,-"  |
     *       o      _,-"      o
     *       |  _,-"          |
     *   (0, 1)"-------------(1, 1)
     */
    let positions = [];

    for (let i = 0; i <= NUM_SEGMENTS; i++) {
      positions = positions.concat([i, -1, 0, i, 1, 0]);
    }

    const model = new Model(gl, Object.assign({}, this.getShaders(), {
      id: this.props.id,
      geometry: new Geometry({
        drawMode: GL.TRIANGLE_STRIP,
        attributes: {
          positions: new Float32Array(positions)
        }
      }),
      isInstanced: true,
      shaderCache: this.context.shaderCache
    }));
    model.setUniforms({
      numSegments: NUM_SEGMENTS
    });
    return model;
  }

  calculateInstanceSourcePositions(attribute) {
    const _this$props = this.props,
          data = _this$props.data,
          getSourcePosition = _this$props.getSourcePosition;
    const value = attribute.value,
          size = attribute.size;
    let i = 0;
    data.forEach(object => {
      const sourcePosition = getSourcePosition(object);
      value[i + 0] = sourcePosition[0];
      value[i + 1] = sourcePosition[1];
      value[i + 2] = isNaN(sourcePosition[2]) ? 0 : sourcePosition[2];
      i += size;
    });
  }

  calculateInstanceTargetPositions(attribute) {
    const _this$props2 = this.props,
          data = _this$props2.data,
          getTargetPosition = _this$props2.getTargetPosition;
    const value = attribute.value,
          size = attribute.size;
    let i = 0;
    data.forEach(object => {
      const targetPosition = getTargetPosition(object);
      value[i + 0] = targetPosition[0];
      value[i + 1] = targetPosition[1];
      value[i + 2] = isNaN(targetPosition[2]) ? 0 : targetPosition[2];
      i += size;
    });
  }

  calculateInstanceControlPoints(attribute) {
    const _this$props3 = this.props,
          data = _this$props3.data,
          getControlPoint = _this$props3.getControlPoint;
    const value = attribute.value,
          size = attribute.size;
    let i = 0;
    data.forEach(object => {
      const controlPoint = getControlPoint(object);
      value[i + 0] = controlPoint[0];
      value[i + 1] = controlPoint[1];
      value[i + 2] = isNaN(controlPoint[2]) ? 0 : controlPoint[2];
      i += size;
    });
  }

  calculateInstanceSourceTargetPositions64xyLow(attribute) {
    const _this$props4 = this.props,
          data = _this$props4.data,
          getSourcePosition = _this$props4.getSourcePosition,
          getTargetPosition = _this$props4.getTargetPosition;
    const value = attribute.value,
          size = attribute.size;
    let i = 0;
    data.forEach(object => {
      const sourcePosition = getSourcePosition(object);
      const targetPosition = getTargetPosition(object);
      value[i + 0] = fp64LowPart(sourcePosition[0]);
      value[i + 1] = fp64LowPart(sourcePosition[1]);
      value[i + 2] = fp64LowPart(targetPosition[0]);
      value[i + 3] = fp64LowPart(targetPosition[1]);
      i += size;
    });
  }

  calculateInstanceColors(attribute) {
    const _this$props5 = this.props,
          data = _this$props5.data,
          getColor = _this$props5.getColor;
    const value = attribute.value,
          size = attribute.size;
    let i = 0;
    data.forEach(object => {
      const color = getColor(object);
      value[i + 0] = color[0];
      value[i + 1] = color[1];
      value[i + 2] = color[2];
      value[i + 3] = isNaN(color[3]) ? 255 : color[3];
      i += size;
    });
  }

}
BezierCurveLayer.layerName = 'BezierCurveLayer';
BezierCurveLayer.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iZXppZXItY3VydmUtbGF5ZXIvYmV6aWVyLWN1cnZlLWxheWVyLmpzIl0sIm5hbWVzIjpbIkxheWVyIiwiR0wiLCJNb2RlbCIsIkdlb21ldHJ5IiwiZnA2NCIsImZwNjRMb3dQYXJ0IiwidnMiLCJmcyIsIk5VTV9TRUdNRU5UUyIsIkRFRkFVTFRfQ09MT1IiLCJkZWZhdWx0UHJvcHMiLCJzdHJva2VXaWR0aCIsImdldFNvdXJjZVBvc2l0aW9uIiwieCIsInNvdXJjZVBvc2l0aW9uIiwiZ2V0VGFyZ2V0UG9zaXRpb24iLCJ0YXJnZXRQb3NpdGlvbiIsImdldENvbnRyb2xQb2ludCIsImNvbnRyb2xQb2ludCIsImdldENvbG9yIiwiY29sb3IiLCJCZXppZXJDdXJ2ZUxheWVyIiwiZ2V0U2hhZGVycyIsIm1vZHVsZXMiLCJpbml0aWFsaXplU3RhdGUiLCJhdHRyaWJ1dGVNYW5hZ2VyIiwic3RhdGUiLCJhZGRJbnN0YW5jZWQiLCJpbnN0YW5jZVNvdXJjZVBvc2l0aW9ucyIsInNpemUiLCJ0cmFuc2l0aW9uIiwiYWNjZXNzb3IiLCJ1cGRhdGUiLCJjYWxjdWxhdGVJbnN0YW5jZVNvdXJjZVBvc2l0aW9ucyIsImluc3RhbmNlVGFyZ2V0UG9zaXRpb25zIiwiY2FsY3VsYXRlSW5zdGFuY2VUYXJnZXRQb3NpdGlvbnMiLCJpbnN0YW5jZUNvbnRyb2xQb2ludHMiLCJjYWxjdWxhdGVJbnN0YW5jZUNvbnRyb2xQb2ludHMiLCJpbnN0YW5jZUNvbG9ycyIsInR5cGUiLCJVTlNJR05FRF9CWVRFIiwiY2FsY3VsYXRlSW5zdGFuY2VDb2xvcnMiLCJ1cGRhdGVBdHRyaWJ1dGUiLCJwcm9wcyIsIm9sZFByb3BzIiwiY2hhbmdlRmxhZ3MiLCJpbnZhbGlkYXRlQWxsIiwidXBkYXRlU3RhdGUiLCJnbCIsImNvbnRleHQiLCJzZXRTdGF0ZSIsIm1vZGVsIiwiX2dldE1vZGVsIiwiZHJhdyIsInVuaWZvcm1zIiwicmVuZGVyIiwiT2JqZWN0IiwiYXNzaWduIiwicG9zaXRpb25zIiwiaSIsImNvbmNhdCIsImlkIiwiZ2VvbWV0cnkiLCJkcmF3TW9kZSIsIlRSSUFOR0xFX1NUUklQIiwiYXR0cmlidXRlcyIsIkZsb2F0MzJBcnJheSIsImlzSW5zdGFuY2VkIiwic2hhZGVyQ2FjaGUiLCJzZXRVbmlmb3JtcyIsIm51bVNlZ21lbnRzIiwiYXR0cmlidXRlIiwiZGF0YSIsInZhbHVlIiwiZm9yRWFjaCIsIm9iamVjdCIsImlzTmFOIiwiY2FsY3VsYXRlSW5zdGFuY2VTb3VyY2VUYXJnZXRQb3NpdGlvbnM2NHh5TG93IiwibGF5ZXJOYW1lIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBLFNBQVFBLEtBQVIsUUFBb0IsZUFBcEI7QUFDQSxPQUFPQyxFQUFQLE1BQWUsbUJBQWY7QUFDQSxTQUFRQyxLQUFSLEVBQWVDLFFBQWYsRUFBeUJDLElBQXpCLFFBQW9DLFNBQXBDO01BQ09DLFcsR0FBZUQsSSxDQUFmQyxXO0FBRVAsT0FBT0MsRUFBUCxNQUFlLGtDQUFmO0FBQ0EsT0FBT0MsRUFBUCxNQUFlLG9DQUFmO0FBRUEsTUFBTUMsWUFBWSxHQUFHLEVBQXJCO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxDQUFQLEVBQVUsR0FBVixDQUF0QjtBQUVBLE1BQU1DLFlBQVksR0FBRztBQUNuQkMsRUFBQUEsV0FBVyxFQUFFLENBRE07QUFFbkJQLEVBQUFBLElBQUksRUFBRSxLQUZhO0FBR25CUSxFQUFBQSxpQkFBaUIsRUFBRUMsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLGNBSFA7QUFJbkJDLEVBQUFBLGlCQUFpQixFQUFFRixDQUFDLElBQUlBLENBQUMsQ0FBQ0csY0FKUDtBQUtuQkMsRUFBQUEsZUFBZSxFQUFFSixDQUFDLElBQUlBLENBQUMsQ0FBQ0ssWUFMTDtBQU1uQkMsRUFBQUEs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IjpbIi8vIENvcHlyaWdodCAoYykgMjAxNSAtIDIwMTcgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge0xheWVyfSBmcm9tICdAZGVjay5nbC9jb3JlJztcbmltcG9ydCBHTCBmcm9tICdsdW1hLmdsL2NvbnN0YW50cyc7XG5pbXBvcnQge01vZGVsLCBHZW9tZXRyeSwgZnA2NH0gZnJvbSAnbHVtYS5nbCc7XG5jb25zdCB7ZnA2NExvd1BhcnR9ID0gZnA2NDtcblxuaW1wb3J0IHZzIGZyb20gJy4vYmV6aWVyLWN1cnZlLWxheWVyLXZlcnRleC5nbHNsJztcbmltcG9ydCBmcyBmcm9tICcuL2Jlemllci1jdXJ2ZS1sYXllci1mcmFnbWVudC5nbHNsJztcblxuY29uc3QgTlVNX1NFR01FTlRTID0gNDA7XG5jb25zdCBERUZBVUxUX0NPTE9SID0gWzAsIDAsIDAsIDI1NV07XG5cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgc3Ryb2tlV2lkdGg6IDEsXG4gIGZwNjQ6IGZhbHNlLFxuICBnZXRTb3VyY2VQb3NpdGlvbjogeCA9PiB4LnNvdXJjZVBvc2l0aW9uLFxuICBnZXRUYXJnZXRQb3NpdGlvbjogeCA9PiB4LnRhcmdldFBvc2l0aW9uLFxuICBnZXRDb250cm9sUG9pbnQ6IHggPT4geC5jb250cm9sUG9pbnQsXG4gIGdldENvbG9yOiB4ID0+IHguY29sb3IgfHwgREVGQVVMVF9DT0xPUlxufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQmV6aWVyQ3VydmVMYXllciBleHRlbmRzIExheWVyIHtcbiAgZ2V0U2hhZGVycygpIHtcbiAgICByZXR1cm4ge3ZzLCBmcywgbW9kdWxlczogWydwaWNraW5nJ119O1xuICB9XG5cbiAgaW5pdGlhbGl6ZVN0YXRlKCkge1xuICAgIGNvbnN0IHthdHRyaWJ1dGVNYW5hZ2VyfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAvKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGVuICovXG4gICAgYXR0cmlidXRlTWFuYWdlci5hZGRJbnN0YW5jZWQoe1xuICAgICAgaW5zdGFuY2VTb3VyY2VQb3NpdGlvbnM6IHtcbiAgICAgICAgc2l6ZTogMyxcbiAgICAgICAgdHJhbnNpdGlvbjogdHJ1ZSxcbiAgICAgICAgYWNjZXNzb3I6ICdnZXRTb3VyY2VQb3NpdGlvbicsXG4gICAgICAgIHVwZGF0ZTogdGhpcy5jYWxjdWxhdGVJbnN0YW5jZVNvdXJjZVBvc2l0aW9uc1xuICAgICAgfSxcbiAgICAgIGluc3RhbmNlVGFyZ2V0UG9zaXRpb25zOiB7XG4gICAgICAgIHNpemU6IDMsXG4gICAgICAgIHRyYW5zaXRpb246IHRydWUsXG4gICAgICAgIGFjY2Vzc29yOiAnZ2V0VGFyZ2V0UG9zaXRpb24nLFxuICAgICAgICB1cGRhdGU6IHRoaXMuY2FsY3VsYXRlSW5zdGFuY2VUYXJnZXRQb3NpdGlvbnNcbiAgICAgIH0sXG4gICAgICBpbnN0YW5jZUNvbnRyb2xQb2ludHM6IHtcbiAgICAgICAgc2l6ZTogMyxcbiAgICAgICAgdHJhbnNpdGlvbjogZmFsc2UsXG4gICAgICAgIGFjY2Vzc29yOiAnZ2V0Q29udHJvbFBvaW50JyxcbiAgICAgICAgdXBkYXRlOiB0aGlzLmNhbGN1bGF0ZUluc3RhbmNlQ29udHJvbFBvaW50c1xuICAgICAgfSxcbiAgICAgIGluc3RhbmNlQ29sb3JzOiB7XG4gICAgICAgIHNpemU6IDQsXG4gICAgICAgIHR5cGU6IEdMLlVOU0lHTkVEX0JZVEUsXG4gICAgICAgIHRyYW5zaXRpb246IHRydWUsXG4gICAgICAgIGFjY2Vzc29yOiAnZ2V0Q29sb3InLFxuICAgICAgICB1cGRhdGU6IHRoaXMuY2FsY3VsYXRlSW5zdGFuY2VDb2xvcnNcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvKiBlc2xpbnQtZW5hYmxlIG1heC1sZW4gKi9cbiAgfVxuXG4gIHVwZGF0ZUF0dHJpYnV0ZSh7cHJvcHMsIG9sZFByb3BzLCBjaGFuZ2VGbGFnc30pIHtcbiAgICBpZiAocHJvcHMuZnA2NCAhPT0gb2xkUHJvcHMuZnA2NCkge1xuICAgICAgY29uc3Qge2F0dHJpYnV0ZU1hbmFnZXJ9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIGF0dHJpYnV0ZU1hbmFnZXIuaW52YWxpZGF0ZUFsbCgpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVN0YXRlKHtwcm9wcywgb2xkUHJvcHMsIGNoYW5nZUZsYWdzfSkge1xuICAgIHN1cGVyLnVwZGF0ZVN0YXRlKHtwcm9wcywgb2xkUHJvcHMsIGNoYW5nZUZsYWdzfSk7XG5cbiAgICBpZiAocHJvcHMuZnA2NCAhPT0gb2xkUHJvcHMuZnA2NCkge1xuICAgICAgY29uc3Qge2dsfSA9IHRoaXMuY29udGV4dDtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe21vZGVsOiB0aGlzLl9nZXRNb2RlbChnbCl9KTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVBdHRyaWJ1dGUoe3Byb3BzLCBvbGRQcm9wcywgY2hhbmdlRmxhZ3N9KTtcbiAgfVxuXG4gIGRyYXcoe3VuaWZvcm1zfSkge1xuICAgIGNvbnN0IHtzdHJva2VXaWR0aH0gPSB0aGlzLnByb3BzO1xuXG4gICAgdGhpcy5zdGF0ZS5tb2RlbC5yZW5kZXIoXG4gICAgICBPYmplY3QuYXNzaWduKHt9LCB1bmlmb3Jtcywge1xuICAgICAgICBzdHJva2VXaWR0aFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgX2dldE1vZGVsKGdsKSB7XG4gICAgLypcbiAgICAgKiAgKDAsIC0xKS0tLS0tLS0tLS0tLS1fKDEsIC0xKVxuICAgICAqICAgICAgIHwgICAgICAgICAgXywtXCIgIHxcbiAgICAgKiAgICAgICBvICAgICAgXywtXCIgICAgICBvXG4gICAgICogICAgICAgfCAgXywtXCIgICAgICAgICAgfFxuICAgICAqICAgKDAsIDEpXCItLS0tLS0tLS0tLS0tKDEsIDEpXG4gICAgICovXG4gICAgbGV0IHBvc2l0aW9ucyA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IE5VTV9TRUdNRU5UUzsgaSsrKSB7XG4gICAgICBwb3NpdGlvbnMgPSBwb3NpdGlvbnMuY29uY2F0KFtpLCAtMSwgMCwgaSwgMSwgMF0pO1xuICAgIH1cblxuICAgIGNvbnN0IG1vZGVsID0gbmV3IE1vZGVsKFxuICAgICAgZ2wsXG4gICAgICBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmdldFNoYWRlcnMoKSwge1xuICAgICAgICBpZDogdGhpcy5wcm9wcy5pZCxcbiAgICAgICAgZ2VvbWV0cnk6IG5ldyBHZW9tZXRyeSh7XG4gICAgICAgICAgZHJhd01vZGU6IEdMLlRSSUFOR0xFX1NUUklQLFxuICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIHBvc2l0aW9uczogbmV3IEZsb2F0MzJBcnJheShwb3NpdGlvbnMpXG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgaXNJbnN0YW5jZWQ6IHRydWUsXG4gICAgICAgIHNoYWRlckNhY2hlOiB0aGlzLmNvbnRleHQuc2hhZGVyQ2FjaGVcbiAgICAgIH0pXG4gICAgKTtcbiAgICBtb2RlbC5zZXRVbmlmb3Jtcyh7bnVtU2VnbWVudHM6IE5VTV9TRUdNRU5UU30pO1xuICAgIHJldHVybiBtb2RlbDtcbiAgfVxuXG4gIGNhbGN1bGF0ZUluc3RhbmNlU291cmNlUG9zaXRpb25zKGF0dHJpYnV0ZSkge1xuICAgIGNvbnN0IHtkYXRhLCBnZXRTb3VyY2VQb3NpdGlvbn0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHt2YWx1ZSwgc2l6ZX0gPSBhdHRyaWJ1dGU7XG4gICAgbGV0IGkgPSAwO1xuICAgIGRhdGEuZm9yRWFjaChvYmplY3QgPT4ge1xuICAgICAgY29uc3Qgc291cmNlUG9zaXRpb24gPSBnZXRTb3VyY2VQb3NpdGlvbihvYmplY3QpO1xuICAgICAgdmFsdWVbaSArIDBdID0gc291cmNlUG9zaXRpb25bMF07XG4gICAgICB2YWx1ZVtpICsgMV0gPSBzb3VyY2VQb3NpdGlvblsxXTtcbiAgICAgIHZhbHVlW2kgKyAyXSA9IGlzTmFOKHNvdXJjZVBvc2l0aW9uWzJdKSA/IDAgOiBzb3VyY2VQb3NpdGlvblsyXTtcbiAgICAgIGkgKz0gc2l6ZTtcbiAgICB9KTtcbiAgfVxuXG4gIGNhbGN1bGF0ZUluc3RhbmNlVGFyZ2V0UG9zaXRpb25zKGF0dHJpYnV0ZSkge1xuICAgIGNvbnN0IHtkYXRhLCBnZXRUYXJnZXRQb3NpdGlvbn0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHt2YWx1ZSwgc2l6ZX0gPSBhdHRyaWJ1dGU7XG4gICAgbGV0IGkgPSAwO1xuICAgIGRhdGEuZm9yRWFjaChvYmplY3QgPT4ge1xuICAgICAgY29uc3QgdGFyZ2V0UG9zaXRpb24gPSBnZXRUYXJnZXRQb3NpdGlvbihvYmplY3QpO1xuICAgICAgdmFsdWVbaSArIDBdID0gdGFyZ2V0UG9zaXRpb25bMF07XG4gICAgICB2YWx1ZVtpICsgMV0gPSB0YXJnZXRQb3NpdGlvblsxXTtcbiAgICAgIHZhbHVlW2kgKyAyXSA9IGlzTmFOKHRhcmdldFBvc2l0aW9uWzJdKSA/IDAgOiB0YXJnZXRQb3NpdGlvblsyXTtcbiAgICAgIGkgKz0gc2l6ZTtcbiAgICB9KTtcbiAgfVxuXG4gIGNhbGN1bGF0ZUluc3RhbmNlQ29udHJvbFBvaW50cyhhdHRyaWJ1dGUpIHtcbiAgICBjb25zdCB7ZGF0YSwgZ2V0Q29udHJvbFBvaW50fSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge3ZhbHVlLCBzaXplfSA9IGF0dHJpYnV0ZTtcbiAgICBsZXQgaSA9IDA7XG4gICAgZGF0YS5mb3JFYWNoKG9iamVjdCA9PiB7XG4gICAgICBjb25zdCBjb250cm9sUG9pbnQgPSBnZXRDb250cm9sUG9pbnQob2JqZWN0KTtcbiAgICAgIHZhbHVlW2kgKyAwXSA9IGNvbnRyb2xQb2ludFswXTtcbiAgICAgIHZhbHVlW2kgKyAxXSA9IGNvbnRyb2xQb2ludFsxXTtcbiAgICAgIHZhbHVlW2kgKyAyXSA9IGlzTmFOKGNvbnRyb2xQb2ludFsyXSkgPyAwIDogY29udHJvbFBvaW50WzJdO1xuICAgICAgaSArPSBzaXplO1xuICAgIH0pO1xuICB9XG5cbiAgY2FsY3VsYXRlSW5zdGFuY2VTb3VyY2VUYXJnZXRQb3NpdGlvbnM2NHh5TG93KGF0dHJpYnV0ZSkge1xuICAgIGNvbnN0IHtkYXRhLCBnZXRTb3VyY2VQb3NpdGlvbiwgZ2V0VGFyZ2V0UG9zaXRpb259ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7dmFsdWUsIHNpemV9ID0gYXR0cmlidXRlO1xuICAgIGxldCBpID0gMDtcbiAgICBkYXRhLmZvckVhY2gob2JqZWN0ID0+IHtcbiAgICAgIGNvbnN0IHNvdXJjZVBvc2l0aW9uID0gZ2V0U291cmNlUG9zaXRpb24ob2JqZWN0KTtcbiAgICAgIGNvbnN0IHRhcmdldFBvc2l0aW9uID0gZ2V0VGFyZ2V0UG9zaXRpb24ob2JqZWN0KTtcbiAgICAgIHZhbHVlW2kgKyAwXSA9IGZwNjRMb3dQYXJ0KHNvdXJjZVBvc2l0aW9uWzBdKTtcbiAgICAgIHZhbHVlW2kgKyAxXSA9IGZwNjRMb3dQYXJ0KHNvdXJjZVBvc2l0aW9uWzFdKTtcbiAgICAgIHZhbHVlW2kgKyAyXSA9IGZwNjRMb3dQYXJ0KHRhcmdldFBvc2l0aW9uWzBdKTtcbiAgICAgIHZhbHVlW2kgKyAzXSA9IGZwNjRMb3dQYXJ0KHRhcmdldFBvc2l0aW9uWzFdKTtcbiAgICAgIGkgKz0gc2l6ZTtcbiAgICB9KTtcbiAgfVxuXG4gIGNhbGN1bGF0ZUluc3RhbmNlQ29sb3JzKGF0dHJpYnV0ZSkge1xuICAgIGNvbnN0IHtkYXRhLCBnZXRDb2xvcn0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHt2YWx1ZSwgc2l6ZX0gPSBhdHRyaWJ1dGU7XG4gICAgbGV0IGkgPSAwO1xuICAgIGRhdGEuZm9yRWFjaChvYmplY3QgPT4ge1xuICAgICAgY29uc3QgY29sb3IgPSBnZXRDb2xvcihvYmplY3QpO1xuICAgICAgdmFsdWVbaSArIDBdID0gY29sb3JbMF07XG4gICAgICB2YWx1ZVtpICsgMV0gPSBjb2xvclsxXTtcbiAgICAgIHZhbHVlW2kgKyAyXSA9IGNvbG9yWzJdO1xuICAgICAgdmFsdWVbaSArIDNdID0gaXNOYU4oY29sb3JbM10pID8gMjU1IDogY29sb3JbM107XG4gICAgICBpICs9IHNpemU7XG4gICAgfSk7XG4gIH1cbn1cblxuQmV6aWVyQ3VydmVMYXllci5sYXllck5hbWUgPSAnQmV6aWVyQ3VydmVMYXllcic7XG5CZXppZXJDdXJ2ZUxheWVyLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcztcbiJdfQ==