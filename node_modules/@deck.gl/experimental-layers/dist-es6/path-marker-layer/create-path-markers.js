import { Vector2 } from 'math.gl';

function getLineLength(vPoints) {
  // calculate total length
  let lineLength = 0;

  for (let i = 0; i < vPoints.length - 1; i++) {
    lineLength += vPoints[i].distance(vPoints[i + 1]);
  }

  return lineLength;
}

const DEFAULT_COLOR = [0, 0, 0, 255];
const DEFAULT_DIRECTION = {
  forward: true,
  backward: false
};
export default function createPathMarkers({
  data,
  getPath = x => x.path,
  getDirection = x => x.direction,
  getColor = x => DEFAULT_COLOR,
  getMarkerPercentages = x => [0.5],
  projectFlat
}) {
  const markers = [];

  for (const object of data) {
    const path = getPath(object);
    const direction = getDirection(object) || DEFAULT_DIRECTION;
    const color = getColor(object);
    const vPoints = path.map(p => new Vector2(p));
    const vPointsReverse = vPoints.slice(0).reverse(); // calculate total length

    const lineLength = getLineLength(vPoints); // Ask for where to put markers

    const percentages = getMarkerPercentages(object, {
      lineLength
    }); // Create the markers

    for (const percentage of percentages) {
      if (direction.forward) {
        const marker = createMarkerAlongPath({
          path: vPoints,
          percentage,
          lineLength,
          color,
          object,
          projectFlat
        });
        markers.push(marker);
      }

      if (direction.backward) {
        const marker = createMarkerAlongPath({
          path: vPointsReverse,
          percentage,
          lineLength,
          color,
          object,
          projectFlat
        });
        markers.push(marker);
      }
    }
  }

  return markers;
}

function createMarkerAlongPath({
  path,
  percentage,
  lineLength,
  color,
  object,
  projectFlat
}) {
  const distanceAlong = lineLength * percentage;
  let currentDistance = 0;
  let previousDistance = 0;
  let i = 0;

  for (i = 0; i < path.length - 1; i++) {
    currentDistance += path[i].distance(path[i + 1]);

    if (currentDistance > distanceAlong) {
      break;
    }

    previousDistance = currentDistance;
  }

  const vDirection = path[i + 1].clone().subtract(path[i]).normalize();
  const along = distanceAlong - previousDistance;
  const vCenter = vDirection.clone().multiply(new Vector2(along, along)).add(path[i]);
  const vDirection2 = new Vector2(projectFlat(path[i + 1])).subtract(projectFlat(path[i]));
  const angle = -vDirection2.verticalAngle() * 180 / Math.PI;
  return {
    position: [vCenter.x, vCenter.y, 0],
    angle,
    color,
    object
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYXRoLW1hcmtlci1sYXllci9jcmVhdGUtcGF0aC1tYXJrZXJzLmpzIl0sIm5hbWVzIjpbIlZlY3RvcjIiLCJnZXRMaW5lTGVuZ3RoIiwidlBvaW50cyIsImxpbmVMZW5ndGgiLCJpIiwibGVuZ3RoIiwiZGlzdGFuY2UiLCJERUZBVUxUX0NPTE9SIiwiREVGQVVMVF9ESVJFQ1RJT04iLCJmb3J3YXJkIiwiYmFja3dhcmQiLCJjcmVhdGVQYXRoTWFya2VycyIsImRhdGEiLCJnZXRQYXRoIiwieCIsInBhdGgiLCJnZXREaXJlY3Rpb24iLCJkaXJlY3Rpb24iLCJnZXRDb2xvciIsImdldE1hcmtlclBlcmNlbnRhZ2VzIiwicHJvamVjdEZsYXQiLCJtYXJrZXJzIiwib2JqZWN0IiwiY29sb3IiLCJtYXAiLCJwIiwidlBvaW50c1JldmVyc2UiLCJzbGljZSIsInJldmVyc2UiLCJwZXJjZW50YWdlcyIsInBlcmNlbnRhZ2UiLCJtYXJrZXIiLCJjcmVhdGVNYXJrZXJBbG9uZ1BhdGgiLCJwdXNoIiwiZGlzdGFuY2VBbG9uZyIsImN1cnJlbnREaXN0YW5jZSIsInByZXZpb3VzRGlzdGFuY2UiLCJ2RGlyZWN0aW9uIiwiY2xvbmUiLCJzdWJ0cmFjdCIsIm5vcm1hbGl6ZSIsImFsb25nIiwidkNlbnRlciIsIm11bHRpcGx5IiwiYWRkIiwidkRpcmVjdGlvbjIiLCJhbmdsZSIsInZlcnRpY2FsQW5nbGUiLCJNYXRoIiwiUEkiLCJwb3NpdGlvbiIsInkiXSwibWFwcGluZ3MiOiJBQUFBLFNBQVFBLE9BQVIsUUFBc0IsU0FBdEI7O0FBRUEsU0FBU0MsYUFBVCxDQUF1QkMsT0FBdkIsRUFBZ0M7QUFDOUI7QUFDQSxNQUFJQyxVQUFVLEdBQUcsQ0FBakI7O0FBQ0EsT0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRixPQUFPLENBQUNHLE1BQVIsR0FBaUIsQ0FBckMsRUFBd0NELENBQUMsRUFBekMsRUFBNkM7QUFDM0NELElBQUFB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QUNELFdBQVcsQ0FBQ0UsYUFBWixFQUFELEdBQStCLEdBQWhDLEdBQXVDQyxJQUFJLENBQUNDLEVBQTFEO0FBRUEsU0FBTztBQUFDQyxJQUFBQSxRQUFRLEVBQUUsQ0FBQ1IsT0FBTyxDQUFDNUIsQ0FBVCxFQUFZNEIsT0FBTyxDQUFDUyxDQUFwQixFQUF1QixDQUF2QixDQUFYO0FBQXNDTCxJQUFBQSxLQUF0QztBQUE2Q3ZCLElBQUFBLEtBQTdDO0FBQW9ERCxJQUFBQTtBQUFwRCxHQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1ZlY3RvcjJ9IGZyb20gJ21hdGguZ2wnO1xuXG5mdW5jdGlvbiBnZXRMaW5lTGVuZ3RoKHZQb2ludHMpIHtcbiAgLy8gY2FsY3VsYXRlIHRvdGFsIGxlbmd0aFxuICBsZXQgbGluZUxlbmd0aCA9IDA7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdlBvaW50cy5sZW5ndGggLSAxOyBpKyspIHtcbiAgICBsaW5lTGVuZ3RoICs9IHZQb2ludHNbaV0uZGlzdGFuY2UodlBvaW50c1tpICsgMV0pO1xuICB9XG4gIHJldHVybiBsaW5lTGVuZ3RoO1xufVxuXG5jb25zdCBERUZBVUxUX0NPTE9SID0gWzAsIDAsIDAsIDI1NV07XG5jb25zdCBERUZBVUxUX0RJUkVDVElPTiA9IHtmb3J3YXJkOiB0cnVlLCBiYWNrd2FyZDogZmFsc2V9O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjcmVhdGVQYXRoTWFya2Vycyh7XG4gIGRhdGEsXG4gIGdldFBhdGggPSB4ID0+IHgucGF0aCxcbiAgZ2V0RGlyZWN0aW9uID0geCA9PiB4LmRpcmVjdGlvbixcbiAgZ2V0Q29sb3IgPSB4ID0+IERFRkFVTFRfQ09MT1IsXG4gIGdldE1hcmtlclBlcmNlbnRhZ2VzID0geCA9PiBbMC41XSxcbiAgcHJvamVjdEZsYXRcbn0pIHtcbiAgY29uc3QgbWFya2VycyA9IFtdO1xuXG4gIGZvciAoY29uc3Qgb2JqZWN0IG9mIGRhdGEpIHtcbiAgICBjb25zdCBwYXRoID0gZ2V0UGF0aChvYmplY3QpO1xuICAgIGNvbnN0IGRpcmVjdGlvbiA9IGdldERpcmVjdGlvbihvYmplY3QpIHx8IERFRkFVTFRfRElSRUNUSU9OO1xuICAgIGNvbnN0IGNvbG9yID0gZ2V0Q29sb3Iob2JqZWN0KTtcblxuICAgIGNvbnN0IHZQb2ludHMgPSBwYXRoLm1hcChwID0+IG5ldyBWZWN0b3IyKHApKTtcbiAgICBjb25zdCB2UG9pbnRzUmV2ZXJzZSA9IHZQb2ludHMuc2xpY2UoMCkucmV2ZXJzZSgpO1xuXG4gICAgLy8gY2FsY3VsYXRlIHRvdGFsIGxlbmd0aFxuICAgIGNvbnN0IGxpbmVMZW5ndGggPSBnZXRMaW5lTGVuZ3RoKHZQb2ludHMpO1xuXG4gICAgLy8gQXNrIGZvciB3aGVyZSB0byBwdXQgbWFya2Vyc1xuICAgIGNvbnN0IHBlcmNlbnRhZ2VzID0gZ2V0TWFya2VyUGVyY2VudGFnZXMob2JqZWN0LCB7bGluZUxlbmd0aH0pO1xuXG4gICAgLy8gQ3JlYXRlIHRoZSBtYXJrZXJzXG4gICAgZm9yIChjb25zdCBwZXJjZW50YWdlIG9mIHBlcmNlbnRhZ2VzKSB7XG4gICAgICBpZiAoZGlyZWN0aW9uLmZvcndhcmQpIHtcbiAgICAgICAgY29uc3QgbWFya2VyID0gY3JlYXRlTWFya2VyQWxvbmdQYXRoKHtcbiAgICAgICAgICBwYXRoOiB2UG9pbnRzLFxuICAgICAgICAgIHBlcmNlbnRhZ2UsXG4gICAgICAgICAgbGluZUxlbmd0aCxcbiAgICAgICAgICBjb2xvcixcbiAgICAgICAgICBvYmplY3QsXG4gICAgICAgICAgcHJvamVjdEZsYXRcbiAgICAgICAgfSk7XG4gICAgICAgIG1hcmtlcnMucHVzaChtYXJrZXIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZGlyZWN0aW9uLmJhY2t3YXJkKSB7XG4gICAgICAgIGNvbnN0IG1hcmtlciA9IGNyZWF0ZU1hcmtlckFsb25nUGF0aCh7XG4gICAgICAgICAgcGF0aDogdlBvaW50c1JldmVyc2UsXG4gICAgICAgICAgcGVyY2VudGFnZSxcbiAgICAgICAgICBsaW5lTGVuZ3RoLFxuICAgICAgICAgIGNvbG9yLFxuICAgICAgICAgIG9iamVjdCxcbiAgICAgICAgICBwcm9qZWN0RmxhdFxuICAgICAgICB9KTtcbiAgICAgICAgbWFya2Vycy5wdXNoKG1hcmtlcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hcmtlcnM7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hcmtlckFsb25nUGF0aCh7cGF0aCwgcGVyY2VudGFnZSwgbGluZUxlbmd0aCwgY29sb3IsIG9iamVjdCwgcHJvamVjdEZsYXR9KSB7XG4gIGNvbnN0IGRpc3RhbmNlQWxvbmcgPSBsaW5lTGVuZ3RoICogcGVyY2VudGFnZTtcbiAgbGV0IGN1cnJlbnREaXN0YW5jZSA9IDA7XG4gIGxldCBwcmV2aW91c0Rpc3RhbmNlID0gMDtcbiAgbGV0IGkgPSAwO1xuICBmb3IgKGkgPSAwOyBpIDwgcGF0aC5sZW5ndGggLSAxOyBpKyspIHtcbiAgICBjdXJyZW50RGlzdGFuY2UgKz0gcGF0aFtpXS5kaXN0YW5jZShwYXRoW2kgKyAxXSk7XG4gICAgaWYgKGN1cnJlbnREaXN0YW5jZSA+IGRpc3RhbmNlQWxvbmcpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBwcmV2aW91c0Rpc3RhbmNlID0gY3VycmVudERpc3RhbmNlO1xuICB9XG5cbiAgY29uc3QgdkRpcmVjdGlvbiA9IHBhdGhbaSArIDFdXG4gICAgLmNsb25lKClcbiAgICAuc3VidHJhY3QocGF0aFtpXSlcbiAgICAubm9ybWFsaXplKCk7XG4gIGNvbnN0IGFsb25nID0gZGlzdGFuY2VBbG9uZyAtIHByZXZpb3VzRGlzdGFuY2U7XG4gIGNvbnN0IHZDZW50ZXIgPSB2RGlyZWN0aW9uXG4gICAgLmNsb25lKClcbiAgICAubXVsdGlwbHkobmV3IFZlY3RvcjIoYWxvbmcsIGFsb25nKSlcbiAgICAuYWRkKHBhdGhbaV0pO1xuXG4gIGNvbnN0IHZEaXJlY3Rpb24yID0gbmV3IFZlY3RvcjIocHJvamVjdEZsYXQocGF0aFtpICsgMV0pKS5zdWJ0cmFjdChwcm9qZWN0RmxhdChwYXRoW2ldKSk7XG4gIGNvbnN0IGFuZ2xlID0gKC12RGlyZWN0aW9uMi52ZXJ0aWNhbEFuZ2xlKCkgKiAxODApIC8gTWF0aC5QSTtcblxuICByZXR1cm4ge3Bvc2l0aW9uOiBbdkNlbnRlci54LCB2Q2VudGVyLnksIDBdLCBhbmdsZSwgY29sb3IsIG9iamVjdH07XG59XG4iXX0=