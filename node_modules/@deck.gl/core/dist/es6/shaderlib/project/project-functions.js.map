{"version":3,"sources":["../../../../src/shaderlib/project/project-functions.js"],"names":["COORDINATE_SYSTEM","LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD","vec4_transformMat4","vec3_sub","getDistanceScales","addMetersToLngLat","lngLatZToWorldPosition","lngLatZ","viewport","offsetMode","longitude","latitude","z","projectFlat","X","Y","distanceScales","scale","Z","pixelsPerMeter","normalizeParameters","opts","normalizedParams","Object","assign","coordinateSystem","coordinateOrigin","fromCoordinateSystem","fromCoordinateOrigin","undefined","LNGLAT","zoom","LNGLAT_OFFSETS","Math","fround","getWorldPosition","position","modelMatrix","x","y","LNGLAT_DEPRECATED","METER_OFFSETS","IDENTITY","projectPosition","params","worldPosition","originWorld"],"mappings":"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","sourcesContent":["/**\n * Projection utils\n * TODO: move to Viewport class?\n */\nimport {COORDINATE_SYSTEM} from '../../lib/constants';\nimport {LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD} from './viewport-uniforms';\n\nimport vec4_transformMat4 from 'gl-vec4/transformMat4';\nimport vec3_sub from 'gl-vec3/subtract';\nimport {getDistanceScales, addMetersToLngLat} from 'viewport-mercator-project';\n\n// In project.glsl, offset modes calculate z differently from LNG_LAT mode.\n// offset modes apply the y adjustment (pixelsPerMeter2) when projecting z\n// LNG_LAT mode only use the linear scale.\nfunction lngLatZToWorldPosition(lngLatZ, viewport, offsetMode = false) {\n  const [longitude, latitude, z = 0] = lngLatZ;\n  const [X, Y] = viewport.projectFlat(lngLatZ);\n  const distanceScales = offsetMode\n    ? getDistanceScales({longitude, latitude, scale: viewport.scale})\n    : viewport.getDistanceScales();\n  const Z = z * distanceScales.pixelsPerMeter[2];\n  return [X, Y, Z];\n}\n\nfunction normalizeParameters(opts) {\n  const normalizedParams = Object.assign({}, opts);\n\n  const {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = opts;\n\n  if (fromCoordinateSystem === undefined) {\n    normalizedParams.fromCoordinateSystem = coordinateSystem;\n  }\n  if (fromCoordinateOrigin === undefined) {\n    normalizedParams.fromCoordinateOrigin = coordinateOrigin;\n  }\n\n  if (\n    coordinateSystem === COORDINATE_SYSTEM.LNGLAT &&\n    viewport.zoom >= LNGLAT_AUTO_OFFSET_ZOOM_THRESHOLD\n  ) {\n    normalizedParams.coordinateSystem = COORDINATE_SYSTEM.LNGLAT_OFFSETS;\n    normalizedParams.coordinateOrigin = [\n      Math.fround(viewport.longitude),\n      Math.fround(viewport.latitude)\n    ];\n  }\n\n  return normalizedParams;\n}\n\nexport function getWorldPosition(\n  position,\n  {viewport, modelMatrix, coordinateSystem, coordinateOrigin, offsetMode}\n) {\n  let [x, y, z] = position;\n\n  if (modelMatrix) {\n    [x, y, z] = vec4_transformMat4([], [x, y, z, 1.0], modelMatrix);\n  }\n\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT:\n    case COORDINATE_SYSTEM.LNGLAT_DEPRECATED:\n      return lngLatZToWorldPosition([x, y, z], viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      return lngLatZToWorldPosition(\n        [x + coordinateOrigin[0], y + coordinateOrigin[1], z + (coordinateOrigin[2] || 0)],\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.METER_OFFSETS:\n      return lngLatZToWorldPosition(\n        addMetersToLngLat(coordinateOrigin, [x, y, z]),\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.IDENTITY:\n    default:\n      return [x, y, z];\n  }\n}\n\n/**\n * Equivalent to project_position in project.glsl\n * projects a user supplied position to world position in the target coordinates system\n * @param {array} position - [x, y, z]\n * @param {object} params\n * @param {Viewport} params.viewport - the current viewport\n * @param {number} params.coordinateSystem - the coordinate system to project into\n * @param {array} params.coordinateOrigin - the coordinate origin to project into\n * @param {Matrix4} [params.modelMatrix] - the model matrix of the supplied position\n * @param {number} [params.fromCoordinateSystem] - the coordinate system that the\n *   supplied position is in. Default to the same as `coordinateSystem`.\n * @param {array} [params.fromCoordinateOrigin] - the coordinate origin that the\n *   supplied position is in. Default to the same as `coordinateOrigin`.\n */\nexport function projectPosition(position, params) {\n  const {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    // optional\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = normalizeParameters(params);\n\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n    case COORDINATE_SYSTEM.METER_OFFSETS: {\n      const worldPosition = getWorldPosition(position, {\n        viewport,\n        modelMatrix,\n        coordinateSystem: fromCoordinateSystem,\n        coordinateOrigin: fromCoordinateOrigin,\n        offsetMode: true\n      });\n      const originWorld = lngLatZToWorldPosition(coordinateOrigin, viewport, true);\n      vec3_sub(worldPosition, worldPosition, originWorld);\n\n      return worldPosition;\n    }\n\n    case COORDINATE_SYSTEM.LNGLAT:\n    case COORDINATE_SYSTEM.LNGLAT_DEPRECATED:\n    case COORDINATE_SYSTEM.IDENTITY:\n    default:\n      return getWorldPosition(position, {\n        viewport,\n        modelMatrix,\n        coordinateSystem: fromCoordinateSystem,\n        coordinateOrigin: fromCoordinateOrigin,\n        offsetMode: false\n      });\n  }\n}\n"],"file":"project-functions.js"}