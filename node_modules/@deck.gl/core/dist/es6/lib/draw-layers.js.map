{"version":3,"sources":["../../../src/lib/draw-layers.js"],"names":["GL","withParameters","setParameters","clear","log","assert","LOG_PRIORITY_DRAW","renderCount","getPixelRatio","useDevicePixels","window","devicePixelRatio","getGLViewport","gl","viewport","pixelRatio","height","canvas","clientHeight","dimensions","x","y","width","clearCanvas","drawingBufferWidth","drawingBufferHeight","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","drawLayers","layers","viewports","views","onViewportActive","drawPickingColors","deviceRect","parameters","layerFilter","pass","redrawReason","stats","customRender","forEach","viewportOrDescriptor","i","getViewportFromDescriptor","view","id","drawLayersInViewport","drawPickingBuffer","pickingFBO","framebuffer","scissorTest","scissor","clearColor","blend","blendFunc","ONE","ZERO","CONSTANT_ALPHA","blendEquation","FUNC_ADD","blendColor","glViewport","props","clearOpts","color","depth","renderStats","totalCount","length","visibleCount","compositeCount","pickableCount","layer","layerIndex","shouldDrawLayer","isComposite","visible","pickable","isPicking","drawLayerInViewport","logRenderStats","moduleParameters","Object","assign","create","context","pickingActive","uniforms","layerParameters","getObjectHighlightParameters","drawLayer","priority","primitiveCount","hiddenCount","message","increment","highlightedObjectIndex","highlightColor","pickingHighlightColor","Number","isInteger","pickingSelectedColor","encodePickingColor"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,OAAOA,EAAP,MAAe,mBAAf;AACA,SAAQC,cAAR,EAAwBC,aAAxB,EAAuCC,KAAvC,QAAmD,SAAnD;AACA,OAAOC,GAAP,MAAgB,cAAhB;AACA,OAAOC,MAAP,MAAmB,iBAAnB;AAEA,MAAMC,iBAAiB,GAAG,CAA1B;AAEA,IAAIC,WAAW,GAAG,CAAlB,C,CAEA;;AACA,OAAO,MAAMC,aAAa,GAAG,CAAC;AAACC,EAAAA;AAAD,CAAD,KAAuB;AAClDJ,EAAAA,MAAM,CAAC,OAAOI,eAAP,KAA2B,SAA5B,EAAuC,yBAAvC,CAAN;AACA,SAAOA,eAAe,IAAI,OAAOC,MAAP,KAAkB,WAArC,GAAmDA,MAAM,CAACC,gBAA1D,GAA6E,CAApF;AACD,CAHM,C,CAKP;;AACA,MAAMC,aAAa,GAAG,CAACC,EAAD,EAAK;AAACC,EAAAA,QAAD;AAAWC,EAAAA;AAAX,CAAL,KAAgC;AACpD;AACA,QAAMC,MAAM,GAAGH,EAAE,CAACI,MAAH,GAAYJ,EAAE,CAACI,MAAH,CAAUC,YAAtB,GAAqC,GAApD,CAFoD,CAGpD;;AACA,QAAMC,UAAU,GAAGL,QAAnB;AACA,SAAO,CACLK,UAAU,CAACC,CAAX,GAAeL,UADV,EAEL,CAACC,MAAM,GAAGG,UAAU,CAACE,CAApB,GAAwBF,UAAU,CAACH,MAApC,IAA8CD,UAFzC,EAGLI,UAAU,CAACG,KAAX,GAAmBP,UAHd,EAILI,UAAU,CAACH,MAAX,GAAoBD,UAJf,CAAP;AAMD,CAXD,C,CAaA;;;AAEA,SAASQ,WAAT,CAAqBV,EAArB,EAAyB;AAACJ,EAAAA;AAAD,CAAzB,EAA4C;AAC1C;AACA,QAAMa,KAAK,GAAGT,EAAE,CAACW,kBAAjB;AACA,QAAMR,MAAM,GAAGH,EAAE,CAACY,mBAAlB,CAH0C,CAI1C;;AACAxB,EAAAA,cAAc,CAACY,EAAD,EAAK;AAACC,IAAAA,QAAQ,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAOQ,KAAP,EAAcN,MAAd;AAAX,GAAL,EAAwC,MAAM;AAC1DH,IAAAA,EAAE,CAACV,KAAH,CAASH,EAAE,CAAC0B,gBAAH,GAAsB1B,EAAE,CAAC2B,gBAAlC;AACD,GAFa,CAAd;AAGD,C,CAED;;;AACA,OAAO,SAASC,UAAT,CACLf,EADK,EAEL;AACEgB,EAAAA,MADF;AAEEC,EAAAA,SAFF;AAGEC,EAAAA,KAHF;AAIEC,EAAAA,gBAJF;AAKEvB,EAAAA,eALF;AAMEwB,EAAAA,iBAAiB,GAAG,KANtB;AAOEC,EAAAA,UAAU,GAAG,IAPf;AAQEC,EAAAA,UAAU,GAAG,EARf;AASEC,EAAAA,WAAW,GAAG,IAThB;AAUEC,EAAAA,IAAI,GAAG,MAVT;AAWEC,EAAAA,YAAY,GAAG,EAXjB;AAYEC,EAAAA,KAZF;AAaEC,EAAAA;AAbF,CAFK,EAiBL;AACA,MAAI,CAACA,YAAL,EAAmB;AACjBjB,IAAAA,WAAW,CAACV,EAAD,EAAK;AAACJ,MAAAA;AAAD,KAAL,CAAX;AACD,GAHD,CAKA;;;AAEAqB,EAAAA,SAAS,CAACW,OAAV,CAAkB,CAACC,oBAAD,EAAuBC,CAAvB,KAA6B;AAC7C,UAAM7B,QAAQ,GAAG8B,yBAAyB,CAACF,oBAAD,CAA1C;AACA,UAAMG,IAAI,GAAGd,KAAK,IAAIA,KAAK,CAACjB,QAAQ,CAACgC,EAAV,CAA3B,CAF6C,CAI7C;;AACAd,IAAAA,gBAAgB,CAAClB,QAAD,CAAhB,CAL6C,CAO7C;;AACAiC,IAAAA,oBAAoB,CAAClC,EAAD,EAAK;AACvBgB,MAAAA,MADuB;AAEvBf,MAAAA,QAFuB;AAGvB+B,MAAAA,IAHuB;AAIvBpC,MAAAA,eAJuB;AAKvBwB,MAAAA,iBALuB;AAMvBC,MAAAA,UANuB;AAOvBC,MAAAA,UAPuB;AAQvBC,MAAAA,WARuB;AASvBC,MAAAA,IATuB;AAUvBC,MAAAA,YAVuB;AAWvBC,MAAAA;AAXuB,KAAL,CAApB;AAaD,GArBD,EAPA,CA8BA;AACD,C,CAED;AACA;;AACA,OAAO,SAASS,iBAAT,CACLnC,EADK,EAEL;AACEgB,EAAAA,MADF;AAEEC,EAAAA,SAFF;AAGEE,EAAAA,gBAHF;AAIEvB,EAAAA,eAJF;AAKEwC,EAAAA,UALF;AAMEf,EAAAA,UAAU,EAAE;AAACd,IAAAA,CAAD;AAAIC,IAAAA,CAAJ;AAAOC,IAAAA,KAAP;AAAcN,IAAAA;AAAd,GANd;AAOEoB,EAAAA,WAAW,GAAG,IAPhB;AAQEE,EAAAA,YAAY,GAAG;AARjB,CAFK,EAYL;AACA;AACA;AACA;AACA;AACA;AACA,SAAOrC,cAAc,CACnBY,EADmB,EAEnB;AACEqC,IAAAA,WAAW,EAAED,UADf;AAEEE,IAAAA,WAAW,EAAE,IAFf;AAGEC,IAAAA,OAAO,EAAE,CAAChC,CAAD,EAAIC,CAAJ,EAAOC,KAAP,EAAcN,MAAd,CAHX;AAIEqC,IAAAA,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV;AAJd,GAFmB,EAQnB,MAAM;AACJzB,IAAAA,UAAU,CAACf,EAAD,EAAK;AACbgB,MAAAA,MADa;AAEbC,MAAAA,SAFa;AAGbE,MAAAA,gBAHa;AAIbvB,MAAAA,eAJa;AAKbwB,MAAAA,iBAAiB,EAAE,IALN;AAMbG,MAAAA,WANa;AAObC,MAAAA,IAAI,EAAE,SAPO;AAQbC,MAAAA,YARa;AASbH,MAAAA,UAAU,EAAE;AACVmB,QAAAA,KAAK,EAAE,IADG;AAEVC,QAAAA,SAAS,EAAE,CAAC1C,EAAE,CAAC2C,GAAJ,EAAS3C,EAAE,CAAC4C,IAAZ,EAAkB5C,EAAE,CAAC6C,cAArB,EAAqC7C,EAAE,CAAC4C,IAAxC,CAFD;AAGVE,QAAAA,aAAa,EAAE9C,EAAE,CAAC+C,QAHR;AAIVC,QAAAA,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV;AAJF;AATC,KAAL,CAAV;AAgBD,GAzBkB,CAArB;AA2BD,C,CAED;AACA;AACA;;AACA,SAASd,oBAAT,CACElC,EADF,EAEE;AACEgB,EAAAA,MADF;AAEEf,EAAAA,QAFF;AAGE+B,EAAAA,IAHF;AAIEpC,EAAAA,eAJF;AAKEwB,EAAAA,iBAAiB,GAAG,KALtB;AAMEC,EAAAA,UAAU,GAAG,IANf;AAOEC,EAAAA,UAAU,GAAG,EAPf;AAQEC,EAAAA,WARF;AASEC,EAAAA,IAAI,GAAG,MATT;AAUEC,EAAAA,YAAY,GAAG,EAVjB;AAWEC,EAAAA;AAXF,CAFF,EAeE;AACA,QAAMxB,UAAU,GAAGP,aAAa,CAAC;AAACC,IAAAA;AAAD,GAAD,CAAhC;AACA,QAAMqD,UAAU,GAAGlD,aAAa,CAACC,EAAD,EAAK;AAACC,IAAAA,QAAD;AAAWC,IAAAA;AAAX,GAAL,CAAhC;;AAEA,MAAI8B,IAAI,IAAIA,IAAI,CAACkB,KAAL,CAAW5D,KAAvB,EAA8B;AAC5B,UAAM6D,SAAS,GAAGnB,IAAI,CAACkB,KAAL,CAAW5D,KAAX,KAAqB,IAArB,GAA4B;AAAC8D,MAAAA,KAAK,EAAE,IAAR;AAAcC,MAAAA,KAAK,EAAE;AAArB,KAA5B,GAAyDrB,IAAI,CAACkB,KAAL,CAAW5D,KAAtF;AACAF,IAAAA,cAAc,CACZY,EADY,EAEZ;AACEsC,MAAAA,WAAW,EAAE,IADf;AAEEC,MAAAA,OAAO,EAAEU;AAFX,KAFY,EAMZ,MAAM3D,KAAK,CAACU,EAAD,EAAKmD,SAAL,CANC,CAAd;AAQD,GAdD,CAgBA;;;AACA,QAAMG,WAAW,GAAG;AAClBC,IAAAA,UAAU,EAAEvC,MAAM,CAACwC,MADD;AAElBC,IAAAA,YAAY,EAAE,CAFI;AAGlBC,IAAAA,cAAc,EAAE,CAHE;AAIlBC,IAAAA,aAAa,EAAE;AAJG,GAApB,CAjBA,CAwBA;;AAEAtE,EAAAA,aAAa,CAACW,EAAD,EAAKsB,UAAU,IAAI,EAAnB,CAAb,CA1BA,CA4BA;;AACAN,EAAAA,MAAM,CAACY,OAAP,CAAe,CAACgC,KAAD,EAAQC,UAAR,KAAuB;AACpC;AACA,QAAIC,eAAe,GAAG,CAACF,KAAK,CAACG,WAAP,IAAsBH,KAAK,CAACV,KAAN,CAAYc,OAAxD;;AACA,QAAI5C,iBAAJ,EAAuB;AACrB0C,MAAAA,eAAe,GAAGA,eAAe,IAAIF,KAAK,CAACV,KAAN,CAAYe,QAAjD;AACD;;AACD,QAAIH,eAAe,IAAIvC,WAAvB,EAAoC;AAClCuC,MAAAA,eAAe,GAAGvC,WAAW,CAAC;AAACqC,QAAAA,KAAD;AAAQ3D,QAAAA,QAAR;AAAkBiE,QAAAA,SAAS,EAAE9C;AAA7B,OAAD,CAA7B;AACD,KARmC,CAUpC;;;AACA,QAAI0C,eAAe,IAAIF,KAAK,CAACV,KAAN,CAAYe,QAAnC,EAA6C;AAC3CX,MAAAA,WAAW,CAACK,aAAZ;AACD;;AACD,QAAIC,KAAK,CAACG,WAAV,EAAuB;AACrBT,MAAAA,WAAW,CAACI,cAAZ;AACD,KAhBmC,CAkBpC;;;AACA,QAAII,eAAJ,EAAqB;AACnBR,MAAAA,WAAW,CAACG,YAAZ;AAEAU,MAAAA,mBAAmB,CAAC;AAClBnE,QAAAA,EADkB;AAElB4D,QAAAA,KAFkB;AAGlBC,QAAAA,UAHkB;AAIlBzC,QAAAA,iBAJkB;AAKlBlB,QAAAA,UALkB;AAMlB+C,QAAAA,UANkB;AAOlB3B,QAAAA;AAPkB,OAAD,CAAnB;AASD;AACF,GAhCD;AAkCA5B,EAAAA,WAAW;AAEX0E,EAAAA,cAAc,CAAC;AAACd,IAAAA,WAAD;AAAc9B,IAAAA,IAAd;AAAoBC,IAAAA,YAApB;AAAkCC,IAAAA;AAAlC,GAAD,CAAd;AACD;;AAED,SAASyC,mBAAT,CAA6B;AAC3BnE,EAAAA,EAD2B;AAE3B4D,EAAAA,KAF2B;AAG3BC,EAAAA,UAH2B;AAI3BzC,EAAAA,iBAJ2B;AAK3BlB,EAAAA,UAL2B;AAM3B+C,EAAAA,UAN2B;AAO3B3B,EAAAA;AAP2B,CAA7B,EAQG;AACD,QAAM+C,gBAAgB,GAAGC,MAAM,CAACC,MAAP,CAAcD,MAAM,CAACE,MAAP,CAAcZ,KAAK,CAACV,KAApB,CAAd,EAA0C;AACjEjD,IAAAA,QAAQ,EAAE2D,KAAK,CAACa,OAAN,CAAcxE,QADyC;AAEjEyE,IAAAA,aAAa,EAAEtD,iBAAiB,GAAG,CAAH,GAAO,CAF0B;AAGjEtB,IAAAA,gBAAgB,EAAEI;AAH+C,GAA1C,CAAzB;AAMA,QAAMyE,QAAQ,GAAGL,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBX,KAAK,CAACa,OAAN,CAAcE,QAAhC,EAA0C;AAACd,IAAAA;AAAD,GAA1C,CAAjB,CAPC,CASD;AACA;;AACA,QAAMe,eAAe,GAAGN,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBX,KAAK,CAACV,KAAN,CAAY5B,UAAZ,IAA0B,EAA5C,EAAgDA,UAAhD,CAAxB;AAEAgD,EAAAA,MAAM,CAACC,MAAP,CAAcK,eAAd,EAA+B;AAC7B3E,IAAAA,QAAQ,EAAEgD;AADmB,GAA/B;;AAIA,MAAI7B,iBAAJ,EAAuB;AACrBkD,IAAAA,MAAM,CAACC,MAAP,CAAcK,eAAd,EAA+B;AAC7B5B,MAAAA,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAACa,UAAU,GAAG,CAAd,IAAmB,GAA7B;AADiB,KAA/B;AAGD,GAJD,MAIO;AACLS,IAAAA,MAAM,CAACC,MAAP,CAAcF,gBAAd,EAAgCQ,4BAA4B,CAACjB,KAAD,CAA5D;AACD;;AAEDA,EAAAA,KAAK,CAACkB,SAAN,CAAgB;AACdT,IAAAA,gBADc;AAEdM,IAAAA,QAFc;AAGdrD,IAAAA,UAAU,EAAEsD;AAHE,GAAhB;AAKD;;AAED,SAASR,cAAT,CAAwB;AAACd,EAAAA,WAAD;AAAc9B,EAAAA,IAAd;AAAoBC,EAAAA,YAApB;AAAkCC,EAAAA;AAAlC,CAAxB,EAAkE;AAChE,MAAInC,GAAG,CAACwF,QAAJ,IAAgBtF,iBAApB,EAAuC;AAAA,UAC9B8D,UAD8B,GAC6BD,WAD7B,CAC9BC,UAD8B;AAAA,UAClBE,YADkB,GAC6BH,WAD7B,CAClBG,YADkB;AAAA,UACJC,cADI,GAC6BJ,WAD7B,CACJI,cADI;AAAA,UACYC,aADZ,GAC6BL,WAD7B,CACYK,aADZ;AAErC,UAAMqB,cAAc,GAAGzB,UAAU,GAAGG,cAApC;AACA,UAAMuB,WAAW,GAAGD,cAAc,GAAGvB,YAArC;AAEA,QAAIyB,OAAO,GAAG,EAAd;AACAA,IAAAA,OAAO,IAAK,WAAUxF,WAAY;EACpC+D,YAAa,QAAOF,UAAW,eAAc/B,IAAK,YAAWC,YAAa,GADxE;;AAEA,QAAIlC,GAAG,CAACwF,QAAJ,GAAetF,iBAAnB,EAAsC;AACpCyF,MAAAA,OAAO,IAAK;GACfD,WAAY,YAAWvB,cAAe,cAAaC,aAAc,YAD9D;AAED;;AAEDpE,IAAAA,GAAG,CAACA,GAAJ,CAAQE,iBAAR,EAA2ByF,OAA3B;;AAEA,QAAIxD,KAAJ,EAAW;AACTA,MAAAA,KAAK,CAACyD,SAAN,CAAgB,eAAhB,EAAiC1B,YAAjC;AACD;AACF;AACF,C,CAED;;;AACA,SAAS1B,yBAAT,CAAmCF,oBAAnC,EAAyD;AACvD,SAAOA,oBAAoB,CAAC5B,QAArB,GAAgC4B,oBAAoB,CAAC5B,QAArD,GAAgE4B,oBAAvE;AACD;AAED;;;;;;AAIA,SAASgD,4BAAT,CAAsCjB,KAAtC,EAA6C;AAC3C;AACA;AAF2C,uBAGMA,KAAK,CAACV,KAHZ;AAAA,QAGpCkC,sBAHoC,gBAGpCA,sBAHoC;AAAA,QAGZC,cAHY,gBAGZA,cAHY;AAI3C,QAAM/D,UAAU,GAAG;AACjBgE,IAAAA,qBAAqB,EAAED;AADN,GAAnB,CAJ2C,CAQ3C;AACA;;AACA,MAAIE,MAAM,CAACC,SAAP,CAAiBJ,sBAAjB,CAAJ,EAA8C;AAC5C9D,IAAAA,UAAU,CAACmE,oBAAX,GACEL,sBAAsB,IAAI,CAA1B,GAA8BxB,KAAK,CAAC8B,kBAAN,CAAyBN,sBAAzB,CAA9B,GAAiF,IADnF;AAED;;AACD,SAAO9D,UAAP;AACD","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window */\nimport GL from 'luma.gl/constants';\nimport {withParameters, setParameters, clear} from 'luma.gl';\nimport log from '../utils/log';\nimport assert from '../utils/assert';\n\nconst LOG_PRIORITY_DRAW = 2;\n\nlet renderCount = 0;\n\n// TODO - Exported for pick-layers.js - Move to util?\nexport const getPixelRatio = ({useDevicePixels}) => {\n  assert(typeof useDevicePixels === 'boolean', 'Invalid useDevicePixels');\n  return useDevicePixels && typeof window !== 'undefined' ? window.devicePixelRatio : 1;\n};\n\n// Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\nconst getGLViewport = (gl, {viewport, pixelRatio}) => {\n  // TODO - dummy default for node\n  const height = gl.canvas ? gl.canvas.clientHeight : 100;\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  const dimensions = viewport;\n  return [\n    dimensions.x * pixelRatio,\n    (height - dimensions.y - dimensions.height) * pixelRatio,\n    dimensions.width * pixelRatio,\n    dimensions.height * pixelRatio\n  ];\n};\n\n// Helper functions\n\nfunction clearCanvas(gl, {useDevicePixels}) {\n  // const pixelRatio = getPixelRatio({useDevicePixels});\n  const width = gl.drawingBufferWidth;\n  const height = gl.drawingBufferHeight;\n  // clear depth and color buffers, restoring transparency\n  withParameters(gl, {viewport: [0, 0, width, height]}, () => {\n    gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n  });\n}\n\n// Draw a list of layers in a list of viewports\nexport function drawLayers(\n  gl,\n  {\n    layers,\n    viewports,\n    views,\n    onViewportActive,\n    useDevicePixels,\n    drawPickingColors = false,\n    deviceRect = null,\n    parameters = {},\n    layerFilter = null,\n    pass = 'draw',\n    redrawReason = '',\n    stats,\n    customRender\n  }\n) {\n  if (!customRender) {\n    clearCanvas(gl, {useDevicePixels});\n  }\n\n  // effectManager.preDraw();\n\n  viewports.forEach((viewportOrDescriptor, i) => {\n    const viewport = getViewportFromDescriptor(viewportOrDescriptor);\n    const view = views && views[viewport.id];\n\n    // Update context to point to this viewport\n    onViewportActive(viewport);\n\n    // render this viewport\n    drawLayersInViewport(gl, {\n      layers,\n      viewport,\n      view,\n      useDevicePixels,\n      drawPickingColors,\n      deviceRect,\n      parameters,\n      layerFilter,\n      pass,\n      redrawReason,\n      stats\n    });\n  });\n\n  // effectManager.draw();\n}\n\n// Draws list of layers and viewports into the picking buffer\n// Note: does not sample the buffer, that has to be done by the caller\nexport function drawPickingBuffer(\n  gl,\n  {\n    layers,\n    viewports,\n    onViewportActive,\n    useDevicePixels,\n    pickingFBO,\n    deviceRect: {x, y, width, height},\n    layerFilter = null,\n    redrawReason = ''\n  }\n) {\n  // Make sure we clear scissor test and fbo bindings in case of exceptions\n  // We are only interested in one pixel, no need to render anything else\n  // Note that the callback here is called synchronously.\n  // Set blend mode for picking\n  // always overwrite existing pixel with [r,g,b,layerIndex]\n  return withParameters(\n    gl,\n    {\n      framebuffer: pickingFBO,\n      scissorTest: true,\n      scissor: [x, y, width, height],\n      clearColor: [0, 0, 0, 0]\n    },\n    () => {\n      drawLayers(gl, {\n        layers,\n        viewports,\n        onViewportActive,\n        useDevicePixels,\n        drawPickingColors: true,\n        layerFilter,\n        pass: 'picking',\n        redrawReason,\n        parameters: {\n          blend: true,\n          blendFunc: [gl.ONE, gl.ZERO, gl.CONSTANT_ALPHA, gl.ZERO],\n          blendEquation: gl.FUNC_ADD,\n          blendColor: [0, 0, 0, 0]\n        }\n      });\n    }\n  );\n}\n\n// Draws a list of layers in one viewport\n// TODO - when picking we could completely skip rendering viewports that dont\n// intersect with the picking rect\nfunction drawLayersInViewport(\n  gl,\n  {\n    layers,\n    viewport,\n    view,\n    useDevicePixels,\n    drawPickingColors = false,\n    deviceRect = null,\n    parameters = {},\n    layerFilter,\n    pass = 'draw',\n    redrawReason = '',\n    stats\n  }\n) {\n  const pixelRatio = getPixelRatio({useDevicePixels});\n  const glViewport = getGLViewport(gl, {viewport, pixelRatio});\n\n  if (view && view.props.clear) {\n    const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n    withParameters(\n      gl,\n      {\n        scissorTest: true,\n        scissor: glViewport\n      },\n      () => clear(gl, clearOpts)\n    );\n  }\n\n  // render layers in normal colors\n  const renderStats = {\n    totalCount: layers.length,\n    visibleCount: 0,\n    compositeCount: 0,\n    pickableCount: 0\n  };\n\n  // const {x, y, width, height} = deviceRect || [];\n\n  setParameters(gl, parameters || {});\n\n  // render layers in normal colors\n  layers.forEach((layer, layerIndex) => {\n    // Check if we should draw layer\n    let shouldDrawLayer = !layer.isComposite && layer.props.visible;\n    if (drawPickingColors) {\n      shouldDrawLayer = shouldDrawLayer && layer.props.pickable;\n    }\n    if (shouldDrawLayer && layerFilter) {\n      shouldDrawLayer = layerFilter({layer, viewport, isPicking: drawPickingColors});\n    }\n\n    // Calculate stats\n    if (shouldDrawLayer && layer.props.pickable) {\n      renderStats.pickableCount++;\n    }\n    if (layer.isComposite) {\n      renderStats.compositeCount++;\n    }\n\n    // Draw the layer\n    if (shouldDrawLayer) {\n      renderStats.visibleCount++;\n\n      drawLayerInViewport({\n        gl,\n        layer,\n        layerIndex,\n        drawPickingColors,\n        pixelRatio,\n        glViewport,\n        parameters\n      });\n    }\n  });\n\n  renderCount++;\n\n  logRenderStats({renderStats, pass, redrawReason, stats});\n}\n\nfunction drawLayerInViewport({\n  gl,\n  layer,\n  layerIndex,\n  drawPickingColors,\n  pixelRatio,\n  glViewport,\n  parameters\n}) {\n  const moduleParameters = Object.assign(Object.create(layer.props), {\n    viewport: layer.context.viewport,\n    pickingActive: drawPickingColors ? 1 : 0,\n    devicePixelRatio: pixelRatio\n  });\n\n  const uniforms = Object.assign({}, layer.context.uniforms, {layerIndex});\n\n  // All parameter resolving is done here instead of the layer\n  // Blend parameters must not be overriden\n  const layerParameters = Object.assign({}, layer.props.parameters || {}, parameters);\n\n  Object.assign(layerParameters, {\n    viewport: glViewport\n  });\n\n  if (drawPickingColors) {\n    Object.assign(layerParameters, {\n      blendColor: [0, 0, 0, (layerIndex + 1) / 255]\n    });\n  } else {\n    Object.assign(moduleParameters, getObjectHighlightParameters(layer));\n  }\n\n  layer.drawLayer({\n    moduleParameters,\n    uniforms,\n    parameters: layerParameters\n  });\n}\n\nfunction logRenderStats({renderStats, pass, redrawReason, stats}) {\n  if (log.priority >= LOG_PRIORITY_DRAW) {\n    const {totalCount, visibleCount, compositeCount, pickableCount} = renderStats;\n    const primitiveCount = totalCount - compositeCount;\n    const hiddenCount = primitiveCount - visibleCount;\n\n    let message = '';\n    message += `RENDER #${renderCount} \\\n${visibleCount} (of ${totalCount} layers) to ${pass} because ${redrawReason} `;\n    if (log.priority > LOG_PRIORITY_DRAW) {\n      message += `\\\n(${hiddenCount} hidden, ${compositeCount} composite ${pickableCount} pickable)`;\n    }\n\n    log.log(LOG_PRIORITY_DRAW, message)();\n\n    if (stats) {\n      stats.increment('redraw layers', visibleCount);\n    }\n  }\n}\n\n// Get a viewport from a viewport descriptor (which can be a plain viewport)\nfunction getViewportFromDescriptor(viewportOrDescriptor) {\n  return viewportOrDescriptor.viewport ? viewportOrDescriptor.viewport : viewportOrDescriptor;\n}\n\n/**\n * Returns the picking color of currenlty selected object of the given 'layer'.\n * @return {Array} - the picking color or null if layers selected object is invalid.\n */\nfunction getObjectHighlightParameters(layer) {\n  // TODO - inefficient to update settings every render?\n  // TODO: Add warning if 'highlightedObjectIndex' is > numberOfInstances of the model.\n  const {highlightedObjectIndex, highlightColor} = layer.props;\n  const parameters = {\n    pickingHighlightColor: highlightColor\n  };\n\n  // Update picking module settings if highlightedObjectIndex is set.\n  // This will overwrite any settings from auto highlighting.\n  if (Number.isInteger(highlightedObjectIndex)) {\n    parameters.pickingSelectedColor =\n      highlightedObjectIndex >= 0 ? layer.encodePickingColor(highlightedObjectIndex) : null;\n  }\n  return parameters;\n}\n"],"file":"draw-layers.js"}