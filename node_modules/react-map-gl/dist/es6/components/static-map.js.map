{"version":3,"sources":["../../../src/components/static-map.js"],"names":["PureComponent","createElement","PropTypes","setDiffStyle","isImmutableMap","WebMercatorViewport","Mapbox","isBrowser","checkVisibilityConstraints","mapboxgl","require","TOKEN_DOC_URL","NO_TOKEN_WARNING","noop","UNAUTHORIZED_ERROR_CODE","propTypes","Object","assign","mapStyle","oneOfType","string","object","preventStyleDiffing","bool","disableTokenWarning","visible","visibilityConstraints","defaultProps","childContextTypes","viewport","instanceOf","StaticMap","supported","constructor","props","_queryParams","componentDidMount","componentWillReceiveProps","componentDidUpdate","componentWillUnmount","state","accessTokenInvalid","getMap","bind","queryRenderedFeatures","_updateMapSize","_updateMapStyle","_mapboxMapLoaded","_mapboxMapError","_renderNoTokenWarning","getChildContext","_mapbox","container","_mapboxMap","onError","toJS","_map","newProps","setProps","setState","width","height","finalize","geometry","options","oldProps","sizeChanged","resize","oldMapStyle","setStyle","ref","evt","statusCode","error","status","console","key","id","style","position","left","top","href","render","className","mapContainerStyle","viewState","visibility","children","overflow","displayName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {PureComponent, createElement} from 'react';\nimport PropTypes from 'prop-types';\n\nimport {setDiffStyle} from '../utils/style-utils';\nimport isImmutableMap from '../utils/is-immutable-map';\n\nimport WebMercatorViewport from 'viewport-mercator-project';\n\nimport Mapbox from '../mapbox/mapbox';\nimport isBrowser from '../utils/is-browser';\nimport {checkVisibilityConstraints} from '../utils/map-constraints';\n\nconst mapboxgl = isBrowser ? require('mapbox-gl') : null;\n\n/* eslint-disable max-len */\nconst TOKEN_DOC_URL = 'https://uber.github.io/react-map-gl/#/Documentation/getting-started/about-mapbox-tokens';\nconst NO_TOKEN_WARNING = 'A valid API access token is required to use Mapbox data';\n/* eslint-disable max-len */\n\nfunction noop() {}\n\nconst UNAUTHORIZED_ERROR_CODE = 401;\n\nconst propTypes = Object.assign({}, Mapbox.propTypes, {\n  /** The Mapbox style. A string url or a MapboxGL style Immutable.Map object. */\n  mapStyle: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.object\n  ]),\n  /** There are known issues with style diffing. As stopgap, add option to prevent style diffing. */\n  preventStyleDiffing: PropTypes.bool,\n  /** Hide invalid token warning even if request fails */\n  disableTokenWarning: PropTypes.bool,\n  /** Whether the map is visible */\n  visible: PropTypes.bool,\n\n  /** Advanced features */\n  // Contraints for displaying the map. If not met, then the map is hidden.\n  // Experimental! May be changed in minor version updates.\n  visibilityConstraints: PropTypes.object\n});\n\nconst defaultProps = Object.assign({}, Mapbox.defaultProps, {\n  mapStyle: 'mapbox://styles/mapbox/light-v8',\n  preventStyleDiffing: false,\n  visible: true\n});\n\nconst childContextTypes = {\n  viewport: PropTypes.instanceOf(WebMercatorViewport)\n};\n\nexport default class StaticMap extends PureComponent {\n  static supported() {\n    return mapboxgl && mapboxgl.supported();\n  }\n\n  constructor(props) {\n    super(props);\n    this._queryParams = {};\n    if (!StaticMap.supported()) {\n      this.componentDidMount = noop;\n      this.componentWillReceiveProps = noop;\n      this.componentDidUpdate = noop;\n      this.componentWillUnmount = noop;\n    }\n    this.state = {\n      accessTokenInvalid: false\n    };\n\n    this.getMap = this.getMap.bind(this);\n    this.queryRenderedFeatures = this.queryRenderedFeatures.bind(this);\n    this._updateMapSize = this._updateMapSize.bind(this);\n    this._updateMapStyle = this._updateMapStyle.bind(this);\n    this._mapboxMapLoaded = this._mapboxMapLoaded.bind(this);\n    this._mapboxMapError = this._mapboxMapError.bind(this);\n    this._renderNoTokenWarning = this._renderNoTokenWarning.bind(this);\n  }\n\n  getChildContext() {\n    return {\n      viewport: new WebMercatorViewport(this.props)\n    };\n  }\n\n  componentDidMount() {\n    const {mapStyle} = this.props;\n\n    this._mapbox = new Mapbox(Object.assign({}, this.props, {\n      mapboxgl, // Handle to mapbox-gl library\n      container: this._mapboxMap,\n      onError: this._mapboxMapError,\n      mapStyle: isImmutableMap(mapStyle) ? mapStyle.toJS() : mapStyle\n    }));\n    this._map = this._mapbox.getMap();\n  }\n\n  componentWillReceiveProps(newProps) {\n    this._mapbox.setProps(newProps);\n    this._updateMapStyle(this.props, newProps);\n\n    // this._updateMapViewport(this.props, newProps);\n\n    // Save width/height so that we can check them in componentDidUpdate\n    this.setState({\n      width: this.props.width,\n      height: this.props.height\n    });\n  }\n\n  componentDidUpdate() {\n    // Since Mapbox's map.resize() reads size from DOM\n    // we must wait to read size until after render (i.e. here in \"didUpdate\")\n    this._updateMapSize(this.state, this.props);\n  }\n\n  componentWillUnmount() {\n    this._mapbox.finalize();\n    this._mapbox = null;\n    this._map = null;\n  }\n\n  // External apps can access map this way\n  getMap() {\n    return this._map;\n  }\n\n  /** Uses Mapbox's\n    * queryRenderedFeatures API to find features at point or in a bounding box.\n    * https://www.mapbox.com/mapbox-gl-js/api/#Map#queryRenderedFeatures\n    * To query only some of the layers, set the `interactive` property in the\n    * layer style to `true`.\n    * @param {[Number, Number]|[[Number, Number], [Number, Number]]} geometry -\n    *   Point or an array of two points defining the bounding box\n    * @param {Object} options - query options\n    */\n  queryRenderedFeatures(geometry, options = {}) {\n    return this._map.queryRenderedFeatures(geometry, options);\n  }\n\n  // Note: needs to be called after render (e.g. in componentDidUpdate)\n  _updateMapSize(oldProps, newProps) {\n    const sizeChanged =\n      oldProps.width !== newProps.width || oldProps.height !== newProps.height;\n\n    if (sizeChanged) {\n      this._map.resize();\n      // this._callOnChangeViewport(this._map.transform);\n    }\n  }\n\n  _updateMapStyle(oldProps, newProps) {\n    const mapStyle = newProps.mapStyle;\n    const oldMapStyle = oldProps.mapStyle;\n    if (mapStyle !== oldMapStyle) {\n      if (isImmutableMap(mapStyle)) {\n        if (this.props.preventStyleDiffing) {\n          this._map.setStyle(mapStyle.toJS());\n        } else {\n          setDiffStyle(oldMapStyle, mapStyle, this._map);\n        }\n      } else {\n        this._map.setStyle(mapStyle);\n      }\n    }\n  }\n\n  _mapboxMapLoaded(ref) {\n    this._mapboxMap = ref;\n  }\n\n  // Handle map error\n  _mapboxMapError(evt) {\n    const statusCode = evt.error && evt.error.status || evt.status;\n    if (statusCode === UNAUTHORIZED_ERROR_CODE && !this.state.accessTokenInvalid) {\n      // Mapbox throws unauthorized error - invalid token\n      console.error(NO_TOKEN_WARNING); // eslint-disable-line\n      this.setState({accessTokenInvalid: true});\n    }\n  }\n\n  _renderNoTokenWarning() {\n    if (this.state.accessTokenInvalid && !this.props.disableTokenWarning) {\n      const style = {\n        position: 'absolute',\n        left: 0,\n        top: 0\n      };\n      return (\n        createElement('div', {key: 'warning', id: 'no-token-warning', style}, [\n          createElement('h3', {key: 'header'}, NO_TOKEN_WARNING),\n          createElement('div', {key: 'text'}, 'For information on setting up your basemap, read'),\n          createElement('a', {key: 'link', href: TOKEN_DOC_URL}, 'Note on Map Tokens')\n        ])\n      );\n    }\n\n    return null;\n  }\n\n  render() {\n    const {className, width, height, style, visibilityConstraints} = this.props;\n    const mapContainerStyle = Object.assign({}, style, {width, height, position: 'relative'});\n\n    const visible = this.props.visible &&\n      checkVisibilityConstraints(this.props.viewState || this.props, visibilityConstraints);\n\n    const mapStyle = Object.assign({}, style, {\n      width,\n      height,\n      visibility: visible ? 'visible' : 'hidden'\n    });\n    const overlayContainerStyle = {\n      position: 'absolute',\n      left: 0,\n      top: 0,\n      width,\n      height,\n      overflow: 'hidden'\n    };\n\n    // Note: a static map still handles clicks and hover events\n    return (\n      createElement('div', {\n        key: 'map-container',\n        style: mapContainerStyle,\n        children: [\n          createElement('div', {\n            key: 'map-mapbox',\n            ref: this._mapboxMapLoaded,\n            style: mapStyle,\n            className\n          }),\n          createElement('div', {\n            key: 'map-overlays',\n            // Same as interactive map's overlay container\n            className: 'overlays',\n            style: overlayContainerStyle,\n            children: this.props.children\n          }),\n          this._renderNoTokenWarning()\n        ]\n      })\n    );\n  }\n}\n\nStaticMap.displayName = 'StaticMap';\nStaticMap.propTypes = propTypes;\nStaticMap.defaultProps = defaultProps;\nStaticMap.childContextTypes = childContextTypes;\n"],"file":"static-map.js"}