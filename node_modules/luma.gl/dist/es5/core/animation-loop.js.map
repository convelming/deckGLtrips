{"version":3,"sources":["../../../src/core/animation-loop.js"],"names":["DEFAULT_GL_OPTIONS","preserveDrawingBuffer","AnimationLoop","props","onCreateContext","opts","onAddHTML","onInitialize","onRender","onFinalize","offScreen","gl","glOptions","debug","createFramebuffer","autoResizeViewport","autoResizeDrawingBuffer","useDevicePixels","log","deprecated","useDevicePixelRatio","needsRedraw","setProps","start","bind","stop","_renderFrame","_onMousemove","_onMouseleave","reason","_stopped","_animationFrameId","_startPromise","then","_createWebGLContext","_createFramebuffer","_startEventHandling","_initializeCallbackData","_updateCallbackData","_resizeCanvasDrawingBuffer","_resizeViewport","animationProps","appContext","_addCallbackData","_finalizeCallbackData","id","defaultValue","element","document","getElementById","Number","value","removed","_onSetupFrame","_resizeFramebuffer","_setupFrame","commit","canvas","framebuffer","startTime","Date","now","time","tick","tock","_loop","_animationLoop","_mousePosition","_getSizeAndAspect","width","height","aspect","setNeedsRedraw","Math","floor","_offScreen","Object","assign","Error","_createInfoDiv","wrapperDiv","createElement","body","appendChild","style","position","div","left","bottom","background","html","innerHTML","drawingBufferWidth","drawingBufferHeight","clientWidth","clientHeight","viewport","Framebuffer","resize","addEventListener","e","offsetX","offsetY"],"mappings":";;;;;;;;;;;;;;;AAAA;;AAEA;;AACA;;AACA;;AACA;;AAGA;;AADA;AAGA,IAAMA,kBAAkB,GAAG;AACzBC,EAAAA,qBAAqB,EAAE;AADE,CAA3B;;IAIqBC,a;;;AACnB;;;AAGA,2BAAwB;AAAA,QAAZC,KAAY,uEAAJ,EAAI;AAAA;AAAA,gCAkBlBA,KAlBkB,CAEpBC,eAFoB;AAAA,QAEpBA,eAFoB,sCAEF,UAAAC,IAAI;AAAA,aAAI,mCAAgBA,IAAhB,CAAJ;AAAA,KAFF;AAAA,2BAkBlBF,KAlBkB,CAGpBG,SAHoB;AAAA,QAGpBA,SAHoB,iCAGR,IAHQ;AAAA,8BAkBlBH,KAlBkB,CAIpBI,YAJoB;AAAA,QAIpBA,YAJoB,oCAIL,YAAM,CAAE,CAJH;AAAA,0BAkBlBJ,KAlBkB,CAKpBK,QALoB;AAAA,QAKpBA,QALoB,gCAKT,YAAM,CAAE,CALC;AAAA,4BAkBlBL,KAlBkB,CAMpBM,UANoB;AAAA,QAMpBA,UANoB,kCAMP,YAAM,CAAE,CAND;AAAA,2BAkBlBN,KAlBkB,CAQpBO,SARoB;AAAA,QAQpBA,SARoB,iCAQR,KARQ;AAAA,oBAkBlBP,KAlBkB,CASpBQ,EAToB;AAAA,QASpBA,EAToB,0BASf,IATe;AAAA,2BAkBlBR,KAlBkB,CAUpBS,SAVoB;AAAA,QAUpBA,SAVoB,iCAUR,EAVQ;AAAA,uBAkBlBT,KAlBkB,CAWpBU,KAXoB;AAAA,QAWpBA,KAXoB,6BAWZ,KAXY;AAAA,gCAkBlBV,KAlBkB,CAapBW,iBAboB;AAAA,QAapBA,iBAboB,sCAaA,KAbA;AAAA,gCAkBlBX,KAlBkB,CAgBpBY,kBAhBoB;AAAA,QAgBpBA,kBAhBoB,sCAgBC,IAhBD;AAAA,gCAkBlBZ,KAlBkB,CAiBpBa,uBAjBoB;AAAA,QAiBpBA,uBAjBoB,sCAiBM,IAjBN;AAAA,gCAsBlBb,KAtBkB,CAqBpBc,eArBoB;AAAA,QAqBpBA,eArBoB,sCAqBF,IArBE;;AAwBtB,QAAI,yBAAyBd,KAA7B,EAAoC;AAClCe,iBAAIC,UAAJ,CAAe,qBAAf,EAAsC,iBAAtC;;AACAF,MAAAA,eAAe,GAAGd,KAAK,CAACiB,mBAAxB;AACD;;AAED,SAAKjB,KAAL,GAAa;AACXC,MAAAA,eAAe,EAAfA,eADW;AAEXE,MAAAA,SAAS,EAATA,SAFW;AAGXC,MAAAA,YAAY,EAAZA,YAHW;AAIXC,MAAAA,QAAQ,EAARA,QAJW;AAKXC,MAAAA,UAAU,EAAVA,UALW;AAOXE,MAAAA,EAAE,EAAFA,EAPW;AAQXC,MAAAA,SAAS,EAATA,SARW;AASXC,MAAAA,KAAK,EAALA,KATW;AAUXC,MAAAA,iBAAiB,EAAjBA;AAVW,KAAb,CA7BsB,CA0CtB;;AACA,SAAKH,EAAL,GAAUA,EAAV;AACA,SAAKD,SAAL,GAAiBA,SAAjB;AACA,SAAKW,WAAL,GAAmB,IAAnB;AAEA,SAAKC,QAAL,CAAc;AACZP,MAAAA,kBAAkB,EAAlBA,kBADY;AAEZC,MAAAA,uBAAuB,EAAvBA,uBAFY;AAGZC,MAAAA,eAAe,EAAfA;AAHY,KAAd,EA/CsB,CAqDtB;;AACA,SAAKM,KAAL,GAAa,KAAKA,KAAL,CAAWC,IAAX,CAAgB,IAAhB,CAAb;AACA,SAAKC,IAAL,GAAY,KAAKA,IAAL,CAAUD,IAAV,CAAe,IAAf,CAAZ;AACA,SAAKE,YAAL,GAAoB,KAAKA,YAAL,CAAkBF,IAAlB,CAAuB,IAAvB,CAApB;AAEA,SAAKG,YAAL,GAAoB,KAAKA,YAAL,CAAkBH,IAAlB,CAAuB,IAAvB,CAApB;AACA,SAAKI,aAAL,GAAqB,KAAKA,aAAL,CAAmBJ,IAAnB,CAAwB,IAAxB,CAArB;AAEA,WAAO,IAAP;AACD;;;;mCAEcK,M,EAAQ;AACrB,2BAAO,OAAOA,MAAP,KAAkB,QAAzB;AACA,WAAKR,WAAL,GAAmB,KAAKA,WAAL,IAAoBQ,MAAvC;AACA,aAAO,IAAP;AACD;;;6BAEQ1B,K,EAAO;AACd,UAAI,wBAAwBA,KAA5B,EAAmC;AACjC,aAAKY,kBAAL,GAA0BZ,KAAK,CAACY,kBAAhC;AACD;;AACD,UAAI,6BAA6BZ,KAAjC,EAAwC;AACtC,aAAKa,uBAAL,GAA+Bb,KAAK,CAACa,uBAArC;AACD;;AACD,UAAI,qBAAqBb,KAAzB,EAAgC;AAC9B,aAAKc,eAAL,GAAuBd,KAAK,CAACc,eAA7B;AACD;;AACD,aAAO,IAAP;AACD,K,CAED;AACA;;;;4BACiB;AAAA;;AAAA,UAAXZ,IAAW,uEAAJ,EAAI;AACf,WAAKyB,QAAL,GAAgB,KAAhB,CADe,CAEf;;AACA,UAAI,CAAC,KAAKC,iBAAV,EAA6B;AAC3B;AACA,aAAKC,aAAL,GAAqB,wCACpBC,IADoB,CACf,YAAM;AACV,cAAI,KAAI,CAACH,QAAT,EAAmB;AACjB,mBAAO,IAAP;AACD,WAHS,CAKV;;;AACA,UAAA,KAAI,CAACI,mBAAL,CAAyB7B,IAAzB;;AACA,UAAA,KAAI,CAAC8B,kBAAL;;AACA,UAAA,KAAI,CAACC,mBAAL,GARU,CAUV;;;AACA,UAAA,KAAI,CAACC,uBAAL;;AACA,UAAA,KAAI,CAACC,mBAAL,GAZU,CAcV;;;AACA,UAAA,KAAI,CAACC,0BAAL;;AACA,UAAA,KAAI,CAACC,eAAL,GAhBU,CAkBV;;;AACA,iBAAO,KAAI,CAACjC,YAAL,CAAkB,KAAI,CAACkC,cAAvB,CAAP;AACD,SArBoB,EAsBpBR,IAtBoB,CAsBf,UAAAS,UAAU,EAAI;AAClB,cAAI,CAAC,KAAI,CAACZ,QAAV,EAAoB;AAClB,YAAA,KAAI,CAACa,gBAAL,CAAsBD,UAAU,IAAI,EAApC;;AACA,gBAAIA,UAAU,KAAK,KAAf,IAAwB,CAAC,KAAI,CAACX,iBAAlC,EAAqD;AACnD,cAAA,KAAI,CAACA,iBAAL,GAAyB,uCAAsB,KAAI,CAACL,YAA3B,CAAzB;AACD;AACF;AACF,SA7BoB,CAArB;AA+BD;;AACD,aAAO,IAAP;AACD,K,CAED;;;;2BACO;AACL;AACA,UAAI,KAAKK,iBAAT,EAA4B;AAC1B,aAAKa,qBAAL;;AACA,8CAAqB,KAAKb,iBAA1B;AACA,aAAKA,iBAAL,GAAyB,IAAzB;AACA,aAAKD,QAAL,GAAgB,IAAhB;AACD;;AACD,aAAO,IAAP;AACD;;;sCAEwB;AAAA;;AACvB,aAAO,oBAAK3B,KAAL,EAAWC,eAAX,8BAAP;AACD;;;mCAEqB;AAAA;;AACpB,aAAO,qBAAKD,KAAL,EAAWI,YAAX,+BAAP;AACD;;;+BAEiB;AAAA;;AAChB,aAAO,qBAAKJ,KAAL,EAAWK,QAAX,+BAAP;AACD;;;iCAEmB;AAAA;;AAClB,aAAO,qBAAKL,KAAL,EAAWM,UAAX,+BAAP;AACD,K,CAED;;;;wCAEoBoC,E,EAAsB;AAAA,UAAlBC,YAAkB,uEAAH,CAAG;AACxC,UAAMC,OAAO,GAAGC,QAAQ,CAACC,cAAT,CAAwBJ,EAAxB,CAAhB;AACA,aAAOE,OAAO,GAAGG,MAAM,CAACH,OAAO,CAACI,KAAT,CAAT,GAA2BL,YAAzC;AACD,K,CAED;;;;wCACoB;AAClB5B,iBAAIkC,OAAJ,CAAY,iCAAZ,EAA+C,wBAA/C;;AACA,aAAO,IAAP;AACD,K,CAED;;;;kCAEc;AACZ,UAAI,KAAKC,aAAT,EAAwB;AACtB;AACA,aAAKA,aAAL,CAAmB,KAAKZ,cAAxB,EAFsB,CAGtB;;AACD,OAJD,MAIO;AACL,aAAKF,0BAAL;;AACA,aAAKC,eAAL;;AACA,aAAKc,kBAAL;AACD;AACF;AAED;;;;;;;;mCAKe;AACb,UAAI,KAAKxB,QAAT,EAAmB;AACjB;AACD;;AAED,WAAKyB,WAAL;;AACA,WAAKjB,mBAAL,GANa,CAQb;;;AACA,WAAK9B,QAAL,CAAc,KAAKiC,cAAnB,EATa,CAUb;;AAEA,UAAI,KAAK/B,SAAT,EAAoB;AAClB;AACA,aAAKC,EAAL,CAAQ6C,MAAR,GAAiBvB,IAAjB,CAAsB,KAAKP,YAA3B;AACD,OAHD,MAGO;AACL;AACA,aAAKK,iBAAL,GAAyB,uCAAsB,KAAKL,YAA3B,CAAzB;AACD;AACF,K,CAED;;;;8CAC0B;AACxB,WAAKe,cAAL,GAAsB;AACpB9B,QAAAA,EAAE,EAAE,KAAKA,EADW;AAGpBc,QAAAA,IAAI,EAAE,KAAKA,IAHS;AAIpBgC,QAAAA,MAAM,EAAE,KAAK9C,EAAL,CAAQ8C,MAJI;AAKpBC,QAAAA,WAAW,EAAE,KAAKA,WALE;AAOpB;AACAzC,QAAAA,eAAe,EAAE,KAAKA,eARF;AASpBI,QAAAA,WAAW,EAAE,IATO;AAWpB;AACAsC,QAAAA,SAAS,EAAEC,IAAI,CAACC,GAAL,EAZS;AAapBC,QAAAA,IAAI,EAAE,CAbc;AAcpBC,QAAAA,IAAI,EAAE,CAdc;AAepBC,QAAAA,IAAI,EAAE,CAfc;AAgBpB;AAEA;AACAC,QAAAA,KAAK,EAAE,IAnBa;AAoBpBC,QAAAA,cAAc,EAAE,IApBI;AAqBpBC,QAAAA,cAAc,EAAE,IArBI,CAqBM;;AArBN,OAAtB;AAuBD,K,CAED;;;;0CACsB;AACpB;AACA,WAAK1B,cAAL,CAAoBpB,WAApB,GAAkC,KAAKA,WAAvC;AACA,WAAKA,WAAL,GAAmB,IAAnB;;AAHoB,kCAKY,KAAK+C,iBAAL,EALZ;AAAA,UAKbC,KALa,yBAKbA,KALa;AAAA,UAKNC,MALM,yBAKNA,MALM;AAAA,UAKEC,MALF,yBAKEA,MALF;;AAMpB,UAAIF,KAAK,KAAK,KAAK5B,cAAL,CAAoB4B,KAA9B,IAAuCC,MAAM,KAAK,KAAK7B,cAAL,CAAoB6B,MAA1E,EAAkF;AAChF,aAAKE,cAAL,CAAoB,wBAApB;AACD;;AACD,UAAID,MAAM,KAAK,KAAK9B,cAAL,CAAoB8B,MAAnC,EAA2C;AACzC,aAAKC,cAAL,CAAoB,+BAApB;AACD;;AAED,WAAK/B,cAAL,CAAoB4B,KAApB,GAA4BA,KAA5B;AACA,WAAK5B,cAAL,CAAoB6B,MAApB,GAA6BA,MAA7B;AACA,WAAK7B,cAAL,CAAoB8B,MAApB,GAA6BA,MAA7B;AAEA,WAAK9B,cAAL,CAAoBpB,WAApB,GAAkC,KAAKA,WAAvC,CAjBoB,CAmBpB;;AACA,WAAKoB,cAAL,CAAoBqB,IAApB,GAA2BF,IAAI,CAACC,GAAL,KAAa,KAAKpB,cAAL,CAAoBkB,SAA5D;AACA,WAAKlB,cAAL,CAAoBsB,IAApB,GAA2BU,IAAI,CAACC,KAAL,CAAW,KAAKjC,cAAL,CAAoBqB,IAApB,GAA2B,IAA3B,GAAkC,EAA7C,CAA3B;AACA,WAAKrB,cAAL,CAAoBuB,IAApB,GAtBoB,CAwBpB;;AACA,WAAKvB,cAAL,CAAoBkC,UAApB,GAAiC,KAAKjE,SAAtC;AACD;;;4CAEuB;AACtB;AACA,WAAKD,UAAL,CAAgB,KAAKgC,cAArB,EAFsB,CAGtB;AACD,K,CAED;;;;qCACiBC,U,EAAY;AAC3B,UAAI,sBAAOA,UAAP,MAAsB,QAAtB,IAAkCA,UAAU,KAAK,IAArD,EAA2D;AACzD,aAAKD,cAAL,GAAsBmC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKpC,cAAvB,EAAuCC,UAAvC,CAAtB;AACD;AACF,K,CAED;;;;wCACoBrC,I,EAAM;AACxB;AACAA,MAAAA,IAAI,GAAGuE,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBxE,IAAlB,EAAwBL,kBAAxB,EAA4C,KAAKG,KAAL,CAAWS,SAAvD,CAAP;AACA,WAAKD,EAAL,GAAU,KAAKR,KAAL,CAAWQ,EAAX,IAAiB,KAAKP,eAAL,CAAqBC,IAArB,CAA3B;;AAEA,UAAI,CAAC,yBAAQ,KAAKM,EAAb,CAAL,EAAuB;AACrB,cAAM,IAAImE,KAAJ,CAAU,0DAAV,CAAN;AACD;;AAED,UAAI,KAAK3E,KAAL,CAAWU,KAAf,EAAsB;AACpB,aAAKF,EAAL,GAAU,oCAAiB,KAAKA,EAAtB,CAAV;AACD,OAXuB,CAaxB;;;AACA,yCAAgB,KAAKA,EAArB;;AAEA,WAAKoE,cAAL;AACD;;;qCAEgB;AACf,UAAI,KAAKpE,EAAL,CAAQ8C,MAAR,IAAkB,KAAKtD,KAAL,CAAWG,SAAjC,EAA4C;AAC1C;AACA,YAAM0E,UAAU,GAAGhC,QAAQ,CAACiC,aAAT,CAAuB,KAAvB,CAAnB;AACAjC,QAAAA,QAAQ,CAACkC,IAAT,CAAcC,WAAd,CAA0BH,UAA1B;AACAA,QAAAA,UAAU,CAACI,KAAX,CAAiBC,QAAjB,GAA4B,UAA5B;AACA,YAAMC,GAAG,GAAGtC,QAAQ,CAACiC,aAAT,CAAuB,KAAvB,CAAZ;AACAK,QAAAA,GAAG,CAACF,KAAJ,CAAUC,QAAV,GAAqB,UAArB;AACAC,QAAAA,GAAG,CAACF,KAAJ,CAAUG,IAAV,GAAiB,MAAjB;AACAD,QAAAA,GAAG,CAACF,KAAJ,CAAUI,MAAV,GAAmB,MAAnB;AACAF,QAAAA,GAAG,CAACF,KAAJ,CAAUf,KAAV,GAAkB,OAAlB;AACAiB,QAAAA,GAAG,CAACF,KAAJ,CAAUK,UAAV,GAAuB,OAAvB;AACAT,QAAAA,UAAU,CAACG,WAAX,CAAuB,KAAKxE,EAAL,CAAQ8C,MAA/B;AACAuB,QAAAA,UAAU,CAACG,WAAX,CAAuBG,GAAvB;AACA,YAAMI,IAAI,GAAG,KAAKvF,KAAL,CAAWG,SAAX,CAAqBgF,GAArB,CAAb;;AACA,YAAII,IAAJ,EAAU;AACRJ,UAAAA,GAAG,CAACK,SAAJ,GAAgBD,IAAhB;AACD;AACF;AACF;;;wCAEmB;AAClB;AACA,UAAMrB,KAAK,GAAG,KAAK1D,EAAL,CAAQiF,kBAAtB;AACA,UAAMtB,MAAM,GAAG,KAAK3D,EAAL,CAAQkF,mBAAvB,CAHkB,CAKlB;;AACA,UAAItB,MAAM,GAAG,CAAb;AANkB,4BAOkB,KAAK5D,EAAL,CAAQ8C,MAP1B;AAAA,UAOXqC,WAPW,mBAOXA,WAPW;AAAA,UAOEC,YAPF,mBAOEA,YAPF;;AAQlB,UAAID,WAAW,IAAI,CAAf,IAAoBC,YAAY,IAAI,CAAxC,EAA2C;AACzCxB,QAAAA,MAAM,GAAGD,MAAM,GAAG,CAAT,GAAawB,WAAW,GAAGC,YAA3B,GAA0C,CAAnD;AACD,OAFD,MAEO,IAAI1B,KAAK,GAAG,CAAR,IAAaC,MAAM,GAAG,CAA1B,EAA6B;AAClCC,QAAAA,MAAM,GAAGF,KAAK,GAAGC,MAAjB;AACD;;AAED,aAAO;AAACD,QAAAA,KAAK,EAALA,KAAD;AAAQC,QAAAA,MAAM,EAANA,MAAR;AAAgBC,QAAAA,MAAM,EAANA;AAAhB,OAAP;AACD,K,CAED;;;;sCACkB;AAChB,UAAI,KAAKxD,kBAAT,EAA6B;AAC3B,aAAKJ,EAAL,CAAQqF,QAAR,CAAiB,CAAjB,EAAoB,CAApB,EAAuB,KAAKrF,EAAL,CAAQiF,kBAA/B,EAAmD,KAAKjF,EAAL,CAAQkF,mBAA3D;AACD;AACF,K,CAED;AACA;;;;iDAC6B;AAC3B,UAAI,KAAK7E,uBAAT,EAAkC;AAChC,2CAAgB,KAAKL,EAArB,EAAyB;AAACM,UAAAA,eAAe,EAAE,KAAKA;AAAvB,SAAzB;AACD;AACF,K,CAED;;;;yCACqB;AACnB;AACA,UAAI,KAAKd,KAAL,CAAWW,iBAAf,EAAkC;AAChC,aAAK4C,WAAL,GAAmB,IAAIuC,kBAAJ,CAAgB,KAAKtF,EAArB,CAAnB;AACD;AACF;;;yCAEoB;AACnB,UAAI,KAAK+C,WAAT,EAAsB;AACpB,aAAKA,WAAL,CAAiBwC,MAAjB,CAAwB;AACtB7B,UAAAA,KAAK,EAAE,KAAK1D,EAAL,CAAQiF,kBADO;AAEtBtB,UAAAA,MAAM,EAAE,KAAK3D,EAAL,CAAQkF;AAFM,SAAxB;AAID;AACF,K,CAED;;;;0CAEsB;AACpB,WAAKlF,EAAL,CAAQ8C,MAAR,CAAe0C,gBAAf,CAAgC,WAAhC,EAA6C,KAAKxE,YAAlD;AACA,WAAKhB,EAAL,CAAQ8C,MAAR,CAAe0C,gBAAf,CAAgC,YAAhC,EAA8C,KAAKvE,aAAnD;AACD;;;iCAEYwE,C,EAAG;AACd,WAAK3D,cAAL,CAAoB0B,cAApB,GAAqC,CAACiC,CAAC,CAACC,OAAH,EAAYD,CAAC,CAACE,OAAd,CAArC;AACD;;;kCACaF,C,EAAG;AACf,WAAK3D,cAAL,CAAoB0B,cAApB,GAAqC,IAArC;AACD","sourcesContent":["import {createGLContext, resizeGLContext, resetParameters} from '../webgl-context';\nimport {getPageLoadPromise} from '../webgl-context';\nimport {makeDebugContext} from '../webgl-context/debug-context';\nimport {isWebGL, requestAnimationFrame, cancelAnimationFrame} from '../webgl-utils';\nimport {log} from '../utils';\nimport assert from '../utils/assert';\n\n// TODO - remove dependency on webgl classes\nimport {Framebuffer} from '../webgl';\n\nconst DEFAULT_GL_OPTIONS = {\n  preserveDrawingBuffer: true\n};\n\nexport default class AnimationLoop {\n  /*\n   * @param {HTMLCanvasElement} canvas - if provided, width and height will be passed to context\n   */\n  constructor(props = {}) {\n    const {\n      onCreateContext = opts => createGLContext(opts),\n      onAddHTML = null,\n      onInitialize = () => {},\n      onRender = () => {},\n      onFinalize = () => {},\n\n      offScreen = false,\n      gl = null,\n      glOptions = {},\n      debug = false,\n\n      createFramebuffer = false,\n\n      // view parameters\n      autoResizeViewport = true,\n      autoResizeDrawingBuffer = true\n    } = props;\n\n    let {\n      useDevicePixels = true\n    } = props;\n\n    if ('useDevicePixelRatio' in props) {\n      log.deprecated('useDevicePixelRatio', 'useDevicePixels')();\n      useDevicePixels = props.useDevicePixelRatio;\n    }\n\n    this.props = {\n      onCreateContext,\n      onAddHTML,\n      onInitialize,\n      onRender,\n      onFinalize,\n\n      gl,\n      glOptions,\n      debug,\n      createFramebuffer\n    };\n\n    // state\n    this.gl = gl;\n    this.offScreen = offScreen;\n    this.needsRedraw = null;\n\n    this.setProps({\n      autoResizeViewport,\n      autoResizeDrawingBuffer,\n      useDevicePixels\n    });\n\n    // Bind methods\n    this.start = this.start.bind(this);\n    this.stop = this.stop.bind(this);\n    this._renderFrame = this._renderFrame.bind(this);\n\n    this._onMousemove = this._onMousemove.bind(this);\n    this._onMouseleave = this._onMouseleave.bind(this);\n\n    return this;\n  }\n\n  setNeedsRedraw(reason) {\n    assert(typeof reason === 'string');\n    this.needsRedraw = this.needsRedraw || reason;\n    return this;\n  }\n\n  setProps(props) {\n    if ('autoResizeViewport' in props) {\n      this.autoResizeViewport = props.autoResizeViewport;\n    }\n    if ('autoResizeDrawingBuffer' in props) {\n      this.autoResizeDrawingBuffer = props.autoResizeDrawingBuffer;\n    }\n    if ('useDevicePixels' in props) {\n      this.useDevicePixels = props.useDevicePixels;\n    }\n    return this;\n  }\n\n  // Starts a render loop if not already running\n  // @param {Object} context - contains frame specific info (E.g. tick, width, height, etc)\n  start(opts = {}) {\n    this._stopped = false;\n    // console.debug(`Starting ${this.constructor.name}`);\n    if (!this._animationFrameId) {\n      // Wait for start promise before rendering frame\n      this._startPromise = getPageLoadPromise()\n      .then(() => {\n        if (this._stopped) {\n          return null;\n        }\n\n        // Create the WebGL context\n        this._createWebGLContext(opts);\n        this._createFramebuffer();\n        this._startEventHandling();\n\n        // Initialize the callback data\n        this._initializeCallbackData();\n        this._updateCallbackData();\n\n        // Default viewport setup, in case onInitialize wants to render\n        this._resizeCanvasDrawingBuffer();\n        this._resizeViewport();\n\n        // Note: onIntialize can return a promise (in case it needs to load resources)\n        return this.onInitialize(this.animationProps);\n      })\n      .then(appContext => {\n        if (!this._stopped) {\n          this._addCallbackData(appContext || {});\n          if (appContext !== false && !this._animationFrameId) {\n            this._animationFrameId = requestAnimationFrame(this._renderFrame);\n          }\n        }\n      });\n\n    }\n    return this;\n  }\n\n  // Stops a render loop if already running, finalizing\n  stop() {\n    // console.debug(`Stopping ${this.constructor.name}`);\n    if (this._animationFrameId) {\n      this._finalizeCallbackData();\n      cancelAnimationFrame(this._animationFrameId);\n      this._animationFrameId = null;\n      this._stopped = true;\n    }\n    return this;\n  }\n\n  onCreateContext(...args) {\n    return this.props.onCreateContext(...args);\n  }\n\n  onInitialize(...args) {\n    return this.props.onInitialize(...args);\n  }\n\n  onRender(...args) {\n    return this.props.onRender(...args);\n  }\n\n  onFinalize(...args) {\n    return this.props.onFinalize(...args);\n  }\n\n  // DEPRECATED/REMOVED METHODS\n\n  getHTMLControlValue(id, defaultValue = 1) {\n    const element = document.getElementById(id);\n    return element ? Number(element.value) : defaultValue;\n  }\n\n  // Update parameters\n  setViewParameters() {\n    log.removed('AnimationLoop.setViewParameters', 'AnimationLoop.setProps')();\n    return this;\n  }\n\n  // PRIVATE METHODS\n\n  _setupFrame() {\n    if (this._onSetupFrame) {\n      // call callback\n      this._onSetupFrame(this.animationProps);\n      // end callback\n    } else {\n      this._resizeCanvasDrawingBuffer();\n      this._resizeViewport();\n      this._resizeFramebuffer();\n    }\n  }\n\n  /**\n   * @private\n   * Handles a render loop frame - updates context and calls the application\n   * callback\n   */\n  _renderFrame() {\n    if (this._stopped) {\n      return;\n    }\n\n    this._setupFrame();\n    this._updateCallbackData();\n\n    // call callback\n    this.onRender(this.animationProps);\n    // end callback\n\n    if (this.offScreen) {\n      // commit returns a Promise\n      this.gl.commit().then(this._renderFrame);\n    } else {\n      // Request another render frame (now )\n      this._animationFrameId = requestAnimationFrame(this._renderFrame);\n    }\n  }\n\n  // Initialize the  object that will be passed to app callbacks\n  _initializeCallbackData() {\n    this.animationProps = {\n      gl: this.gl,\n\n      stop: this.stop,\n      canvas: this.gl.canvas,\n      framebuffer: this.framebuffer,\n\n      // Initial values\n      useDevicePixels: this.useDevicePixels,\n      needsRedraw: null,\n\n      // Animation props\n      startTime: Date.now(),\n      time: 0,\n      tick: 0,\n      tock: 0,\n      // canvas\n\n      // Experimental\n      _loop: this,\n      _animationLoop: this,\n      _mousePosition: null      // Event props\n    };\n  }\n\n  // Update the context object that will be passed to app callbacks\n  _updateCallbackData() {\n    // Update redraw reason\n    this.animationProps.needsRedraw = this.needsRedraw;\n    this.needsRedraw = null;\n\n    const {width, height, aspect} = this._getSizeAndAspect();\n    if (width !== this.animationProps.width || height !== this.animationProps.height) {\n      this.setNeedsRedraw('drawing buffer resized');\n    }\n    if (aspect !== this.animationProps.aspect) {\n      this.setNeedsRedraw('drawing buffer aspect changed');\n    }\n\n    this.animationProps.width = width;\n    this.animationProps.height = height;\n    this.animationProps.aspect = aspect;\n\n    this.animationProps.needsRedraw = this.needsRedraw;\n\n    // Increment tick\n    this.animationProps.time = Date.now() - this.animationProps.startTime;\n    this.animationProps.tick = Math.floor(this.animationProps.time / 1000 * 60);\n    this.animationProps.tock++;\n\n    // experimental\n    this.animationProps._offScreen = this.offScreen;\n  }\n\n  _finalizeCallbackData() {\n    // call callback\n    this.onFinalize(this.animationProps);\n    // end callback\n  }\n\n  // Add application's data to the app context object\n  _addCallbackData(appContext) {\n    if (typeof appContext === 'object' && appContext !== null) {\n      this.animationProps = Object.assign({}, this.animationProps, appContext);\n    }\n  }\n\n  // Either uses supplied or existing context, or calls provided callback to create one\n  _createWebGLContext(opts) {\n    // Create the WebGL context if necessary\n    opts = Object.assign({}, opts, DEFAULT_GL_OPTIONS, this.props.glOptions);\n    this.gl = this.props.gl || this.onCreateContext(opts);\n\n    if (!isWebGL(this.gl)) {\n      throw new Error('AnimationLoop.onCreateContext - illegal context returned');\n    }\n\n    if (this.props.debug) {\n      this.gl = makeDebugContext(this.gl);\n    }\n\n    // Reset the WebGL context.\n    resetParameters(this.gl);\n\n    this._createInfoDiv();\n  }\n\n  _createInfoDiv() {\n    if (this.gl.canvas && this.props.onAddHTML) {\n      /* global document */\n      const wrapperDiv = document.createElement('div');\n      document.body.appendChild(wrapperDiv);\n      wrapperDiv.style.position = 'relative';\n      const div = document.createElement('div');\n      div.style.position = 'absolute';\n      div.style.left = '10px';\n      div.style.bottom = '10px';\n      div.style.width = '300px';\n      div.style.background = 'white';\n      wrapperDiv.appendChild(this.gl.canvas);\n      wrapperDiv.appendChild(div);\n      const html = this.props.onAddHTML(div);\n      if (html) {\n        div.innerHTML = html;\n      }\n    }\n  }\n\n  _getSizeAndAspect() {\n    // https://webglfundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html\n    const width = this.gl.drawingBufferWidth;\n    const height = this.gl.drawingBufferHeight;\n\n    // https://webglfundamentals.org/webgl/lessons/webgl-anti-patterns.html\n    let aspect = 1;\n    const {clientWidth, clientHeight} = this.gl.canvas;\n    if (clientWidth >= 0 && clientHeight >= 0) {\n      aspect = height > 0 ? clientWidth / clientHeight : 1;\n    } else if (width > 0 && height > 0) {\n      aspect = width / height;\n    }\n\n    return {width, height, aspect};\n  }\n\n  // Default viewport setup\n  _resizeViewport() {\n    if (this.autoResizeViewport) {\n      this.gl.viewport(0, 0, this.gl.drawingBufferWidth, this.gl.drawingBufferHeight);\n    }\n  }\n\n  // Resize the render buffer of the canvas to match canvas client size\n  // Optionally multiplying with devicePixel ratio\n  _resizeCanvasDrawingBuffer() {\n    if (this.autoResizeDrawingBuffer) {\n      resizeGLContext(this.gl, {useDevicePixels: this.useDevicePixels});\n    }\n  }\n\n  // TBD - deprecated?\n  _createFramebuffer() {\n    // Setup default framebuffer\n    if (this.props.createFramebuffer) {\n      this.framebuffer = new Framebuffer(this.gl);\n    }\n  }\n\n  _resizeFramebuffer() {\n    if (this.framebuffer) {\n      this.framebuffer.resize({\n        width: this.gl.drawingBufferWidth,\n        height: this.gl.drawingBufferHeight\n      });\n    }\n  }\n\n  // Event handling\n\n  _startEventHandling() {\n    this.gl.canvas.addEventListener('mousemove', this._onMousemove);\n    this.gl.canvas.addEventListener('mouseleave', this._onMouseleave);\n  }\n\n  _onMousemove(e) {\n    this.animationProps._mousePosition = [e.offsetX, e.offsetY];\n  }\n  _onMouseleave(e) {\n    this.animationProps._mousePosition = null;\n  }\n}\n"],"file":"animation-loop.js"}