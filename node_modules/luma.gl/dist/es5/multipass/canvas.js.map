{"version":3,"sources":["../../../src/multipass/canvas.js"],"names":["DEFAULT_VS","Canvas","canvas","document","createElement","width","clientWidth","height","clientHeight","gl","opts","premultipliedAlpha","Error","texture","spareTexture","flippedModel","filters","key","props","filter","bind","element","Texture2D","pixels","resize","realToCSSPixels","displayWidth","Math","floor","displayHeight","style","viewport","node","parentNode","insertBefore","removeChild","multiPassRenderer","MultiPassRenderer","ClearPass","TexturePass","CopyPass","screen","render","shaderModule","ShaderModulePass","w","h","array","Uint8Array","drawTo","readPixels","type","getExtension","testTexture","format","error","destroy","extraTexture","Model","vs","fs","isInitialized"],"mappings":"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","sourcesContent":["import 'luma.gl/debug';\n\nimport {\n  createGLContext,\n  Model,\n  Texture2D,\n  _MultiPassRenderer as MultiPassRenderer,\n  _ClearPass as ClearPass,\n  _CopyPass as CopyPass,\n  _TexturePass as TexturePass\n} from 'luma.gl';\n\nimport ShaderModulePass from './shader-module-pass';\n\n/* global document */\n\nconst DEFAULT_VS = `\\\nattribute vec2 vertex;\nattribute vec2 _texCoord;\nvarying vec2 texCoord;\nvoid main() {\n  texCoord = _texCoord;\n  gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);\n}\n`;\n\nexport default class Canvas {\n  constructor() {\n    this.canvas = document.createElement('canvas');\n    this.width = this.canvas.clientWidth;\n    this.height = this.canvas.clientHeight;\n\n    this.gl = createGLContext({canvas: this.canvas, opts: {premultipliedAlpha: false}});\n\n    if (!this.gl) {\n      throw new Error('This browser does not support WebGL');\n    }\n\n    this.texture = null;\n    this.spareTexture = null;\n    this.flippedModel = null;\n  }\n\n  installFiltersAsMethods(filters) {\n    // // Filter methods\n    for (const key in filters) {\n      if (key !== 'canvas') {\n        this[key] = props => this.filter(filters[key], props).bind(this);\n      }\n    }\n  }\n\n  setTexture(element) {\n    this.texture = new Texture2D(this.gl, {pixels: element});\n    this.resize(this.gl, this.texture.width, this.texture.height);\n    return this;\n  }\n\n  resize(gl, width, height) {\n    const realToCSSPixels = 1; // window.devicePixelRatio || 1;\n\n    // Check if the canvas is not the same size.\n    if (gl.canvas.width !== width || gl.canvas.height !== height) {\n\n      // Make the canvas the same size\n      gl.canvas.width = width;\n      gl.canvas.height = height;\n\n      // Lookup the size the browser is displaying the canvas in CSS pixels\n      // and compute a size needed to make our drawingbuffer match it in\n      // device pixels.\n      const displayWidth = Math.floor(width / realToCSSPixels);\n      const displayHeight = Math.floor(height / realToCSSPixels);\n\n      gl.canvas.style.width = `${displayWidth}px`;\n      gl.canvas.style.height = `${displayHeight}px`;\n\n      gl.viewport(0, 0, width, height);\n\n      this.width = displayWidth;\n      this.height = displayHeight;\n    }\n  }\n\n  replace(node) {\n    node.parentNode.insertBefore(this.canvas, node);\n    node.parentNode.removeChild(node);\n    return this;\n  }\n\n  // Draw a texture to the canvas, with an optional width and height to scale to.\n  // If no width and height are given then the original texture width and height\n  // are used.\n  draw() {\n    this.multiPassRenderer = new MultiPassRenderer(this.gl, [\n      new ClearPass(this.gl),\n      new TexturePass(this.gl, {texture: this.texture}),\n      new CopyPass(this.gl, {screen: true})\n    ]);\n\n    this.multiPassRenderer.render();\n\n    return this;\n  }\n\n  update() {\n    this.multiPassRenderer.render({});\n    return this;\n  }\n\n  filter(shaderModule, props) {\n    this.multiPassRenderer = new MultiPassRenderer(this.gl, [\n      new ClearPass(this.gl),\n      new TexturePass(this.gl, {texture: this.texture}),\n      new ShaderModulePass(this.gl, shaderModule, props),\n      new CopyPass(this.gl, {screen: true})\n    ]);\n\n    this.multiPassRenderer.render();\n\n    return this;\n  }\n\n  /*\n  contents() {\n    // const gl = this.gl;\n    // const texture = new Texture2D(this.gl, {\n    //   width: this.texture.width,\n    //   height: this.texture.height,\n    //   format: gl.RGBA,\n    //   type: gl.UNSIGNED_BYTE\n    // });\n    // this.texture.use();\n    // texture.drawTo(() => this.getDefaultModel(this.gl).drawRect());\n    // return wrapTexture(texture);\n  }\n  */\n\n  // Get a Uint8 array of pixel values: [r, g, b, a, r, g, b, a, ...]\n  // Length of the array will be width * height * 4.\n  getPixelArray() {\n    const gl = this.gl;\n    const w = this.texture.width;\n    const h = this.texture.height;\n    const array = new Uint8Array(w * h * 4);\n    this.texture.drawTo(() => gl.readPixels(0, 0, w, h, gl.RGBA, gl.UNSIGNED_BYTE, array));\n    return array;\n  }\n\n  _initialize(width, height) {\n    const gl = this.gl;\n    let type = gl.UNSIGNED_BYTE;\n\n    // Go for floating point buffer textures if we can, it'll make the bokeh\n    // filter look a lot better. Note that on Windows, ANGLE does not let you\n    // render to a floating-point texture when linear filtering is enabled.\n    // See http://crbug.com/172278 for more information.\n    if (this.gl.getExtension('OES_texture_float') && gl.getExtension('OES_texture_float_linear')) {\n      const testTexture = new Texture2D(this.gl, {\n        width: 100,\n        height: 100,\n        format: gl.RGBA,\n        type: gl.FLOAT\n      });\n\n      try {\n        // Only use gl.FLOAT if we can render to it\n        testTexture.drawTo(() => {\n          type = gl.FLOAT;\n        });\n      } catch (error) {\n        // ignore\n      }\n      testTexture.destroy();\n    }\n\n    if (this.spareTexture) {\n      this.spareTexture.destroy();\n    }\n    this.width = width;\n    this.height = height;\n    this.texture = new Texture2D(this.gl, {width, height, format: gl.RGBA, type});\n    this.spareTexture = new Texture2D(this.gl, {width, height, format: gl.RGBA, type});\n    this.extraTexture = this.extraTexture ||\n      new Texture2D(this.gl, {width: 0, height: 0, format: gl.RGBA, type});\n    this.flippedModel = this.flippedModel || new Model(this.gl, {\n      vs: DEFAULT_VS,\n      fs: `\\\nuniform sampler2D texture;\nvarying vec2 texCoord;\nvoid main() {\n  gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));\n}\n`\n    });\n    this.isInitialized = true;\n  }\n}\n"],"file":"canvas.js"}